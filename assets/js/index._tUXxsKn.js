const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/virtual_pwa-register.CFtM-w0k.js","assets/js/vendor-map.CN-MMHnt.js","assets/js/vendor-alpine.D9MLegQT.js","assets/js/vendor-utils.Dw8P0qyA.js"])))=>i.map(i=>d[i]);
import{r as le,g as ce,a as ue}from"./vendor-map.CN-MMHnt.js";import{m,a as de,b as pe,c as he,d as fe}from"./vendor-alpine.D9MLegQT.js";import{F as me}from"./vendor-utils.Dw8P0qyA.js";function ge(r,e){for(var t=0;t<e.length;t++){const n=e[t];if(typeof n!="string"&&!Array.isArray(n)){for(const i in n)if(i!=="default"&&!(i in r)){const o=Object.getOwnPropertyDescriptor(n,i);o&&Object.defineProperty(r,i,o.get?o:{enumerable:!0,get:()=>n[i]})}}}return Object.freeze(Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const we="modulepreload",ve=function(r){return"/fam-trainingsplan/"+r},Z={},ye=function(e,t,n){let i=Promise.resolve();if(t&&t.length>0){let u=function(p){return Promise.all(p.map(h=>Promise.resolve(h).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),l=s?.nonce||s?.getAttribute("nonce");i=u(t.map(p=>{if(p=ve(p),p in Z)return;Z[p]=!0;const h=p.endsWith(".css"),g=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${g}`))return;const f=document.createElement("link");if(f.rel=h?"stylesheet":we,h||(f.as="script"),f.crossOrigin="",f.href=p,l&&f.setAttribute("nonce",l),document.head.appendChild(f),h)return new Promise((k,M)=>{f.addEventListener("load",k),f.addEventListener("error",()=>M(new Error(`Unable to preload CSS for ${p}`)))})}))}function o(s){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=s,window.dispatchEvent(l),!l.defaultPrevented)throw s}return i.then(s=>{for(const l of s||[])l.status==="rejected"&&o(l.reason);return e().catch(o)})};var d=le();const be=ce(d),xe=ge({__proto__:null,default:be},[d]);ue();const Te=!1,S=Object.freeze({SECOND:1e3,MINUTE:60*1e3,HOUR:3600*1e3,DAY:1440*60*1e3}),c=Object.freeze({jsonUrl:"/fam-trainingsplan/trainingsplan.json",versionUrl:"/fam-trainingsplan/version.json",cacheEnabled:!0,cacheKey:"trainingsplan_cache_v3",cacheDuration:S.HOUR,favoritesKey:"trainingsplan_favorites_v1",search:Object.freeze({debounceDelay:300,minQueryLength:2,maxResults:100,fuseOptions:Object.freeze({keys:Object.freeze([{name:"training",weight:2},{name:"ort",weight:1.5},{name:"trainer",weight:1},{name:"wochentag",weight:.8},{name:"altersgruppe",weight:.5}]),threshold:.3,distance:100,minMatchCharLength:2,includeScore:!0,includeMatches:!0,ignoreLocation:!0,useExtendedSearch:!1})}),filters:Object.freeze({persistInUrl:!0,debounceDelay:100,urlParams:Object.freeze({wochentag:"tag",ort:"ort",training:"art",altersgruppe:"alter",searchTerm:"suche",nearby:"naehe"})}),map:Object.freeze({defaultCenter:Object.freeze([48.137154,11.576124]),defaultZoom:12,maxZoom:19,minZoom:10,tileLayerUrl:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',geolocation:Object.freeze({enableHighAccuracy:!0,timeout:10*S.SECOND,maximumAge:5*S.MINUTE,maxDistance:50,errorMessages:Object.freeze({PERMISSION_DENIED:"Standort-Berechtigung verweigert",POSITION_UNAVAILABLE:"Standort nicht verfügbar",TIMEOUT:"Standort-Anfrage Timeout",UNKNOWN:"Unbekannter Standort-Fehler"})}),clustering:Object.freeze({enabled:!0,maxClusterRadius:80,spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0})}),ui:Object.freeze({mobileBreakpoint:768,filterDebounce:100,notificationDuration:3e3,animationDuration:300,touch:Object.freeze({swipeThreshold:100,swipeVelocity:.3,swipeMaxTime:1e3,swipeMaxVertical:100}),lazyLoadThreshold:"50px",lazyLoadRootMargin:"100px"}),performance:Object.freeze({enableVirtualScroll:!1,lazyLoadImages:!0,prefetchData:!0,useRequestIdleCallback:typeof requestIdleCallback<"u"}),features:Object.freeze({enableMap:!0,enableSearch:!0,enableQuickFilters:!0,enablePersistence:!0,enableLazyLoading:!0,enableAnalytics:!1,enableShareLinks:!0,enablePrintView:!0,enableDarkMode:!1,enableNotifications:!0,enableOfflineMode:!0,enableFavorites:!0,enableGeolocation:!0,enableUpdateCheck:!0,enableCalendarExport:!0,enableTouchGestures:!0,enableBulkExport:!0}),favorites:Object.freeze({maxCount:100,syncAcrossDevices:!1}),errors:Object.freeze({maxRetries:3,retryDelay:S.SECOND,retryBackoff:2,showUserFriendlyMessages:!0,logToConsole:!0}),logging:Object.freeze({enabled:Te,level:"error",logToConsole:!0,logToServer:!1,levels:Object.freeze({debug:0,info:1,warn:2,error:3})}),iframe:Object.freeze({enabled:!0,parentOrigin:"https://www.freeartsofmovement.com",allowedOrigins:Object.freeze(["https://www.freeartsofmovement.com","http://localhost:5173","http://127.0.0.1:5173"]),debounceDelay:50,minHeight:400,maxHeight:1e4,autoResize:!0}),pwa:Object.freeze({enabled:!0,name:"FAM Trainingsplan",shortName:"FAM",description:"Trainingsplan für Free Arts of Movement",version:"3.0.0",themeColor:"#005892",backgroundColor:"#005892",display:"standalone",orientation:"portrait-primary",scope:"/",startUrl:"/",updateStrategy:"prompt",updateCheckInterval:S.HOUR,offlinePages:Object.freeze(["/","/offline.html"])})});function Ce(r){if(!c.logging.enabled)return!1;const e=c.logging.levels[c.logging.level]??3;return(c.logging.levels[r]??0)>=e}function a(r,e,...t){if(!Ce(r))return;const n=`[trainingsplan:${r}]`,i=new Date().toISOString(),o=t.length>0?t:[];({debug:console.log,info:console.info,warn:console.warn,error:console.error}[r]||console.log)(n,i,e,...o)}let A=null;function B(){if(A)return A;const r=()=>{try{const e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch{return!1}};return A=Object.freeze({isMobile:window.innerWidth<c.ui.mobileBreakpoint,isTouch:"ontouchstart"in window||navigator.maxTouchPoints>0,supportsLocalStorage:r(),supportsGeolocation:"geolocation"in navigator,supportsIntersectionObserver:"IntersectionObserver"in window,supportsResizeObserver:"ResizeObserver"in window,supportsMutationObserver:"MutationObserver"in window,supportsServiceWorker:"serviceWorker"in navigator,supportsShareAPI:"share"in navigator,supportsClipboardAPI:"clipboard"in navigator,isStandalone:window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0,connection:navigator.connection?Object.freeze({effectiveType:navigator.connection.effectiveType,downlink:navigator.connection.downlink,rtt:navigator.connection.rtt,saveData:navigator.connection.saveData}):null}),A}const U=new Map;function ke(r){return U.has(r)||U.set(r,structuredClone(c[r])),U.get(r)}function Me(){return ke("map")}function Fe(r,e=300){let t;return function(...i){const o=()=>{clearTimeout(t),r(...i)};clearTimeout(t),t=setTimeout(o,e)}}function j(r,e=100){let t;return function(...i){t||(r(...i),t=!0,setTimeout(()=>{t=!1},e))}}function Le(r){if(typeof r!="string")return"0";let e=0;for(let t=0;t<r.length;t++){const n=r.charCodeAt(t);e=(e<<5)-e+n,e=e&e}return e.toString()}function Se(r,e){if(!r||!e)return"";const t=n=>{const[i,o]=n.split(":");return`${parseInt(i,10)}:${o}`};return`${t(r)} - ${t(e)} Uhr`}function V(r){return r?r.altersgruppe&&typeof r.altersgruppe=="string"?r.altersgruppe:r.alterVon&&r.alterBis?`${r.alterVon} - ${r.alterBis} Jahre`:r.alterVon?`ab ${r.alterVon} Jahren`:"Alle Altersgruppen":""}function Ae(r){if(typeof r!="string")return"";const e=document.createElement("div");return e.textContent=r,e.innerHTML}function Ee(r){try{const e=new URL(r);return e.protocol==="http:"||e.protocol==="https:"}catch{return!1}}function Oe(r,e,t){return r===1?e:t}function $e(r){return typeof r!="number"||Number.isNaN(r)?"0":r>=1e6?(r/1e6).toFixed(1)+"M":r>=1e3?(r/1e3).toFixed(1)+"k":r.toString()}function Q(r,e=2){const t=10**e;return Math.round(r*t)/t}function _e(r,e){if(!Array.isArray(r))return[];const t=r.map(n=>n[e]).filter(n=>n!=null&&String(n).trim()!=="");return[...new Set(t.map(n=>String(n)))].sort((n,i)=>n.localeCompare(i,"de"))}function Ie(r,e){if(!Array.isArray(r))return{};if(Object.groupBy)return Object.groupBy(r,n=>String(n[e]||"undefined"));const t={};return r.reduce((n,i)=>{const o=String(i[e]||"undefined");return n[o]||(n[o]=[]),n[o].push(i),n},t)}function De(r){if(!Array.isArray(r))return[];const e=[...r];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}async function Ne(){const r=Me().geolocation;if(!navigator.geolocation)throw new Error("Geolocation nicht unterstützt");return new Promise((e,t)=>{const n={enableHighAccuracy:r.enableHighAccuracy,timeout:r.timeout,maximumAge:r.maximumAge};navigator.geolocation.getCurrentPosition(i=>{e({lat:i.coords.latitude,lng:i.coords.longitude,accuracy:i.coords.accuracy})},i=>{const o=r.errorMessages;let s=o.UNKNOWN;switch(i.code){case i.PERMISSION_DENIED:s=o.PERMISSION_DENIED;break;case i.POSITION_UNAVAILABLE:s=o.POSITION_UNAVAILABLE;break;case i.TIMEOUT:s=o.TIMEOUT;break}t(new Error(s))},n)})}function J(r,e,t,n){const o=E(t-r),s=E(n-e),l=Math.sin(o/2)*Math.sin(o/2)+Math.cos(E(r))*Math.cos(E(t))*Math.sin(s/2)*Math.sin(s/2),p=6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)));return Q(p,1)}function E(r){return r*(Math.PI/180)}function ze(r,e){return!Array.isArray(r)||!e?r:r.map(t=>{if(t.lat&&t.lng){const n=J(e.lat,e.lng,t.lat,t.lng);return{...t,distance:n}}return t})}function O(r){if(!r)return null;const t={Montag:1,Dienstag:2,Mittwoch:3,Donnerstag:4,Freitag:5,Samstag:6,Sonntag:0}[r];if(t===void 0)return null;const n=new Date,i=n.getDay();let o=t-i;o<0&&(o+=7),o===0&&n.getHours()>=20&&(o=7);const s=new Date(n);return s.setDate(n.getDate()+o),s.setHours(0,0,0,0),s}function F(r){return r.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z"}function Ue(r){if(!r||typeof r!="string")return 0;const[e,t]=r.split(":").map(n=>parseInt(n,10));return Number.isNaN(e)||Number.isNaN(t)?0:e*60+t}function W(r){const e=O(r.wochentag);if(!e)return null;const t=r.von.split(":"),n=r.bis.split(":"),i=new Date(e);i.setHours(parseInt(t[0],10),parseInt(t[1],10),0);const o=new Date(e);o.setHours(parseInt(n[0],10),parseInt(n[1],10),0);const s=[r.training,"Altersgruppe: "+V(r),r.trainer?"Trainer: "+r.trainer:"",r.anmerkung?"Hinweis: "+r.anmerkung:"",r.link?"Anmeldung: "+r.link:""].filter(Boolean).join("\\n");return["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//FAM Trainingsplan//DE","CALSCALE:GREGORIAN","METHOD:PUBLISH","BEGIN:VEVENT",`UID:${r.id}@fam-trainingsplan`,`DTSTAMP:${F(new Date)}`,`DTSTART:${F(i)}`,`DTEND:${F(o)}`,`SUMMARY:${r.training} - ${r.ort}`,`DESCRIPTION:${s}`,`LOCATION:${r.ort}`,r.link?`URL:${r.link}`:"","STATUS:CONFIRMED","SEQUENCE:0","END:VEVENT","END:VCALENDAR"].filter(Boolean).join(`\r
`)}function Pe(r){if(!Array.isArray(r)||r.length===0)throw new Error("Trainings array is empty or invalid");const e=[];if(r.forEach(t=>{const n=O(t.wochentag);if(n)try{const i=t.von.split(":"),o=t.bis.split(":"),s=new Date(n);s.setHours(parseInt(i[0],10),parseInt(i[1],10),0);const l=new Date(n);l.setHours(parseInt(o[0],10),parseInt(o[1],10),0);const u=[t.training,"Altersgruppe: "+V(t),t.trainer?"Trainer: "+t.trainer:"",t.anmerkung?"Hinweis: "+t.anmerkung:"",t.link?"Anmeldung: "+t.link:""].filter(Boolean).join("\\n"),h={Montag:"MO",Dienstag:"TU",Mittwoch:"WE",Donnerstag:"TH",Freitag:"FR",Samstag:"SA",Sonntag:"SU"}[t.wochentag]||"MO",g=["BEGIN:VEVENT",`UID:${t.id}@fam-trainingsplan`,`DTSTAMP:${F(new Date)}`,`DTSTART:${F(s)}`,`DTEND:${F(l)}`,`SUMMARY:${t.training} - ${t.ort}`,`DESCRIPTION:${u}`,`LOCATION:${t.ort}`,t.link?`URL:${t.link}`:"","STATUS:CONFIRMED",`RRULE:FREQ=WEEKLY;BYDAY=${h};COUNT=52`,"END:VEVENT"].filter(Boolean).join(`\r
`);e.push(g)}catch(i){a("warn",`Skipping invalid training: ${t.id}`,i)}}),e.length===0)throw new Error("No valid events to export");return["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//FAM Trainingsplan//DE","CALSCALE:GREGORIAN","METHOD:PUBLISH","X-WR-CALNAME:FAM Trainingsplan","X-WR-CALDESC:Free Arts of Movement München","X-WR-TIMEZONE:Europe/Berlin",...e,"END:VCALENDAR"].join(`\r
`)}function Re(r,e="training.ics"){try{const t=new Blob([r],{type:"text/calendar;charset=utf-8"}),n=window.URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(n),a("info","iCal file downloaded",{filename:e})}catch(t){throw a("error","iCal download failed",t),t}}function He(r){const e=new URLSearchParams,t=c.filters.urlParams;Object.entries(r).forEach(([o,s])=>{if(!s||s===null||o==="activeQuickFilter"||o.startsWith("_custom"))return;const l=t[o]||o;Array.isArray(s)&&s.length>0?e.set(l,s.join(",")):s!==""&&typeof s!="object"&&e.set(l,String(s))});const n=e.toString(),i=window.location.origin+window.location.pathname;return n?`${i}?${n}`:i}function Ge(){const r=new URLSearchParams(window.location.search),e=c.filters.urlParams,t=Object.fromEntries(Object.entries(e).map(([i,o])=>[o,i])),n={wochentag:[],ort:[],training:[],altersgruppe:[],searchTerm:"",nearby:!1};return r.forEach((i,o)=>{const s=t[o]||o;s in n&&(["wochentag","ort","training","altersgruppe"].includes(s)?n[s]=i?i.split(",").map(l=>l.trim()).filter(l=>l):[]:s==="nearby"?n[s]=i==="true":n[s]=i)}),n}async function Be(r){if(navigator.clipboard&&navigator.clipboard.writeText)try{return await navigator.clipboard.writeText(r),a("info","Text copied to clipboard"),!0}catch(e){a("warn","Clipboard API failed, falling back",e)}try{const e=document.createElement("textarea");e.value=r,e.style.position="fixed",e.style.left="-9999px",e.style.opacity="0",document.body.appendChild(e),e.select();const t=document.execCommand("copy");return document.body.removeChild(e),t&&a("info","Text copied (fallback)"),t}catch(e){return a("error","Copy to clipboard failed",e),!1}}const P={get(r,e=null){try{const t=localStorage.getItem(r);return t?JSON.parse(t):e}catch(t){return a("error","localStorage.get failed",t),e}},set(r,e){try{return localStorage.setItem(r,JSON.stringify(e)),!0}catch(t){return a("error","localStorage.set failed",t),!1}},remove(r){try{return localStorage.removeItem(r),!0}catch(e){return a("error","localStorage.remove failed",e),!1}},clear(){try{return localStorage.clear(),!0}catch(r){return a("error","localStorage.clear failed",r),!1}},has(r){return localStorage.getItem(r)!==null},keys(){return Object.keys(localStorage)}},je={load(){return P.get(c.favoritesKey,[])},save(r){const t=(Array.isArray(r)?r.filter(n=>typeof n=="number"||typeof n=="string"):[]).slice(0,c.favorites.maxCount);return P.set(c.favoritesKey,t)},add(r){const e=this.load();return e.includes(r)?!1:(e.push(r),this.save(e))},remove(r){const e=this.load(),t=e.filter(n=>n!==r);return t.length!==e.length?this.save(t):!1},toggle(r){return this.has(r)?(this.remove(r),!1):(this.add(r),!0)},has(r){return this.load().includes(r)},count(){return this.load().length},clear(){return this.save([])}},v={debounce:Fe,throttle:j,generateHash:Le,formatZeitrange:Se,formatAlter:V,sanitizeHtml:Ae,isValidUrl:Ee,pluralize:Oe,formatNumber:$e,roundTo:Q,extractUnique:_e,groupBy:Ie,shuffle:De,getCurrentPosition:Ne,calculateDistance:J,addDistanceToTrainings:ze,getNextTrainingDate:O,formatICalDate:F,zeitZuMinuten:Ue,createICalEvent:W,createICalBundle:Pe,downloadICalFile:Re,createShareLink:He,getFiltersFromUrl:Ge,copyToClipboard:Be,storage:P,favorites:je};function Ve(){return{allTrainings:[],filteredTrainings:[],metadata:null,loading:!0,error:null,fromCache:!1,searchTimeout:null,fuse:null,map:null,markers:[],markerClusterGroup:null,userHasInteractedWithMap:!1,tileLayer:null,tileLayers:null,layerControl:null,geolocationControl:null,resetControl:null,ariaLiveRegion:null,userLocationMarker:null,userPosition:null,geolocationError:null,geolocationLoading:!1,favorites:[],updateAvailable:!1,latestVersion:null,updateCheckInterval:null,wochentagOrder:{Montag:1,Dienstag:2,Mittwoch:3,Donnerstag:4,Freitag:5,Samstag:6,Sonntag:7}}}class We{constructor(e){this.context=e}loadFiltersFromUrl(){const e=v.getFiltersFromUrl();Object.assign(this.context.$store.ui.filters,e),a("debug","URL filters loaded",e)}updateUrlWithFilters(){if(!c.filters.persistInUrl)return;const e=v.createShareLink(this.context.$store.ui.filters);window.history.replaceState({},"",e)}}class Ke{constructor(e,t,n){this.state=e,this.context=t,this.isFavorite=n.isFavorite,this.updateUrl=n.updateUrl}applyFilters(){const e=this.context.$store.ui.filters;let t=[...this.context.allTrainings];if(typeof e._customPersonalFilter=="string"&&this.matchesCustomPersonalFilter(e._customPersonalFilter)){t=t.filter(n=>this.isFavorite(n.id)),this._finalizeFiltering(t);return}typeof e._customTimeFilter=="string"&&this.hasCustomTimeFilter(e._customTimeFilter)?t=this.applyCustomTimeFilter(t,e._customTimeFilter):t=this.applyStandardWeekdayFilter(t,e.wochentag),typeof e._customFeatureFilter=="string"&&this.hasCustomFeatureFilter(e._customFeatureFilter)&&(t=this.applyCustomFeatureFilter(t,e._customFeatureFilter)),typeof e._customLocationFilter=="string"&&this.hasCustomLocationFilter(e._customLocationFilter)?t=this.applyCustomLocationFilter(t,e._customLocationFilter):t=this.applyStandardLocationFilter(t,e.ort),t=this.applyTrainingTypeFilter(t,e.training),t=this.applyAgeGroupFilter(t,e.altersgruppe),t=this.applySearchFilter(t,e.searchTerm),!e._customLocationFilter&&this.context.userPosition&&c.map.geolocation.maxDistance>0&&(t=t.filter(n=>n.distance&&n.distance<=c.map.geolocation.maxDistance)),this.context.userPosition&&t.sort((n,i)=>(n.distance||999)-(i.distance||999)),this._finalizeFiltering(t)}matchesCustomPersonalFilter(e){return e==="favoriten"}hasCustomTimeFilter(e){return e==="wochenende"||e==="wochentags"}applyCustomTimeFilter(e,t){return t==="wochenende"?e.filter(n=>n.wochentag==="Samstag"||n.wochentag==="Sonntag"):t==="wochentags"?e.filter(n=>n.wochentag&&n.wochentag!=="Samstag"&&n.wochentag!=="Sonntag"):e}hasCustomFeatureFilter(e){return e==="probetraining"}applyCustomFeatureFilter(e,t){return t==="probetraining"?e.filter(n=>n.probetraining?.toLowerCase()==="ja"):e}hasCustomLocationFilter(e){return e==="inMeinerNaehe"}applyCustomLocationFilter(e,t){return t==="inMeinerNaehe"?e.filter(n=>{if(!n.distance)return!1;const i=typeof n.distance=="number"?n.distance:parseFloat(String(n.distance));return!isNaN(i)&&i<=5}):e}applyStandardWeekdayFilter(e,t){if(!this.hasFilterValue(t))return e;const n=this.normalizeToArray(t||"");return e.filter(i=>i.wochentag&&n.some(o=>i.wochentag.toLowerCase()===o.toLowerCase()))}applyStandardLocationFilter(e,t){if(!this.hasFilterValue(t))return e;const n=this.normalizeToArray(t||"");return e.filter(i=>i.ort&&n.some(o=>i.ort.toLowerCase()===o.toLowerCase()))}applyTrainingTypeFilter(e,t){if(!this.hasFilterValue(t))return e;const n=this.normalizeToArray(t||"");return e.filter(i=>i.training&&n.some(o=>i.training.toLowerCase().includes(o.toLowerCase())))}applyAgeGroupFilter(e,t){if(!this.hasFilterValue(t))return e;const n=this.normalizeToArray(t||"");return e.filter(i=>n.some(o=>this.matchesAltersgruppe(i,o)))}applySearchFilter(e,t){if(!t||!t.trim()||!this.context.fuse)return e;const n=this.context.fuse.search(t.trim()),i=new Set(n.map(o=>o.item.id));return e.filter(o=>i.has(o.id))}_finalizeFiltering(e){this.context.filteredTrainings=e,c.filters.persistInUrl&&this.updateUrl(),a("debug","Filters applied",{total:this.context.allTrainings.length,filtered:e.length})}hasFilterValue(e){return e?Array.isArray(e)?e.length>0:typeof e=="string"?e.trim()!=="":!1:!1}normalizeToArray(e){return Array.isArray(e)?e.filter(t=>t&&t.trim()!==""):typeof e=="string"&&e.trim()!==""?[e.trim()]:[]}matchesAltersgruppe(e,t){return e.altersgruppe?String(e.altersgruppe).split(",").map(i=>i.trim().toLowerCase()).some(i=>i===t.toLowerCase()):!1}}class Ze{constructor(e,t,n){this.state=e,this.context=t,this.applyFilters=n.applyFilters}loadFavorites(){this.context.favorites=v.favorites.load(),a("debug","Favorites loaded",{count:this.context.favorites.length})}isFavorite(e){return this.context.favorites.includes(e)}toggleFavorite(e){const t=v.favorites.toggle(e);return this.loadFavorites(),this.context.$nextTick(()=>{this.context.$store.ui.filters.activeQuickFilter==="favoriten"&&this.applyFilters()}),this.context.$store.ui.showNotification(t?"Zu Favoriten hinzugef�gt P":"Von Favoriten entfernt","info",2e3),t}quickFilterFavorites(){this.context.$store.ui.filters.activeQuickFilter==="favoriten"?this.context.$store.ui.filters={wochentag:"",ort:"",training:"",altersgruppe:"",searchTerm:"",activeQuickFilter:null}:this.context.$store.ui.filters={wochentag:"",ort:"",training:"",altersgruppe:"",searchTerm:"",activeQuickFilter:"favoriten"},this.applyFilters()}}class qe{constructor(e,t,n){this.state=e,this.context=t,this.applyFilters=n.applyFilters,this.mapManager=n.mapManager||null,this.loadManualLocation()}loadManualLocation(){if(this.context.$store.ui.manualLocationSet&&this.context.$store.ui.manualLocation){const e=this.context.$store.ui.manualLocation;if(this.context.userPosition=e,a("info","Manual location loaded",this.context.userPosition),this.addDistanceToTrainings(),this.mapManager&&this.context.map&&this.context.userPosition){const{lat:t,lng:n}=this.context.userPosition;this.mapManager.addUserLocationMarker([t,n])}}}async requestUserLocation(){if(!c.features.enableGeolocation)return this.context.geolocationError="Geolocation ist deaktiviert",!1;this.context.geolocationLoading=!0,this.context.geolocationError=null;try{if(this.context.userPosition=await v.getCurrentPosition(),a("info","Position obtained",this.context.userPosition),this.addDistanceToTrainings(),this.applyFilters(),this.mapManager&&this.context.map&&this.context.userPosition){const{lat:e,lng:t}=this.context.userPosition;this.mapManager.addUserLocationMarker([e,t])}return this.context.$store.ui.showNotification("Standort ermittelt! 📍","success",2e3),!0}catch(e){a("error","Geolocation failed",e);const t=e instanceof Error?e.message:String(e);return this.context.geolocationError=t,this.context.$store.ui.showNotification(t,"error",5e3),!1}finally{this.context.geolocationLoading=!1}}addDistanceToTrainings(){this.context.userPosition&&(this.context.allTrainings=v.addDistanceToTrainings(this.context.allTrainings,this.context.userPosition),this.context.allTrainings.forEach(e=>{e.distance!==void 0&&(e.distanceText=e.distance.toFixed(1)+" km")}))}setManualLocation(e,t,n=""){this.context.userPosition={lat:e,lng:t},this.context.$store.ui.manualLocation={lat:e,lng:t},this.context.$store.ui.manualLocationAddress=n,this.context.$store.ui.manualLocationSet=!0,localStorage.setItem("manualLocation",JSON.stringify({lat:e,lng:t,address:n})),this.addDistanceToTrainings(),this.applyFilters(),this.mapManager&&this.context.map&&this.mapManager.addUserLocationMarker([e,t]),a("info","Manual location set",{lat:e,lng:t,address:n})}resetLocation(){this.context.userPosition=null,this.context.$store.ui.manualLocation=null,this.context.$store.ui.manualLocationAddress="",this.context.$store.ui.manualLocationSet=!1,localStorage.removeItem("manualLocation"),this.context.allTrainings.forEach(e=>{delete e.distance,delete e.distanceText}),this.context.map&&(this.context.userLocationMarker&&(this.context.map.removeLayer(this.context.userLocationMarker),this.context.userLocationMarker=null),this.context.geolocationControl&&this.context.geolocationControl._userMarker&&(this.context.map.removeLayer(this.context.geolocationControl._userMarker),this.context.geolocationControl._userMarker=null)),this.context.$store.ui.filters.activeQuickFilter==="nearby"&&(this.context.$store.ui.filters.activeQuickFilter=null),this.applyFilters(),a("info","Location reset successfully")}}const Ye=d.Control.extend({options:{position:"topright",strings:{title:"Mein Standort",locating:"Standort wird ermittelt...",found:"Standort gefunden!",error:"Standort konnte nicht ermittelt werden"}},onAdd(r){this._map=r;const e=d.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-geolocation");return this._button=d.DomUtil.create("button","md-icon-button",e),this._button.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
    `,this._button.title=this.options.strings?.title||"Mein Standort",this._button.setAttribute("aria-label",this.options.strings?.title||"Mein Standort"),d.DomEvent.disableClickPropagation(e),d.DomEvent.disableScrollPropagation(e),d.DomEvent.on(this._button,"click",this._handleClick,this),e},onRemove(r){d.DomEvent.off(this._button,"click",this._handleClick,this)},_handleClick(){const r=this.options.geolocationManager;if(r&&r.context?.$store?.ui){const e=r.context.$store.ui.manualLocationSet,t=r.context.$store.ui.manualLocation;if(e&&t){this._setLoading(!0),setTimeout(()=>{const n=d.latLng(t.lat,t.lng);this._setLoading(!1),this._map.setView(n,16,{animate:!0}),this._showSuccess(n);const i=r.context.$store.ui.manualLocationAddress||"",o=i?`Gespeicherter Standort: ${i}`:"Gespeicherter Standort angezeigt";a("info","Using saved manual location",{lat:t.lat,lng:t.lng}),window.Alpine&&window.Alpine.store&&window.Alpine.store("ui").showNotification(o,"success",3e3)},100);return}}if(!navigator.geolocation){this._showError("Geolocation wird von diesem Browser nicht unterstützt");return}this._setLoading(!0),this._map.locate({setView:!0,maxZoom:16,enableHighAccuracy:c.map.geolocation.enableHighAccuracy,timeout:c.map.geolocation.timeout,maximumAge:c.map.geolocation.maximumAge}),this._map.once("locationfound",e=>{this._setLoading(!1),this._showSuccess(e.latlng),a("info","Geolocation found",{lat:e.latlng.lat,lng:e.latlng.lng,accuracy:e.accuracy})}),this._map.once("locationerror",e=>{this._setLoading(!1);let t=this.options.strings?.error||"Fehler";switch(e.code){case 1:t="Standort-Berechtigung verweigert. Bitte in den Browser-Einstellungen erlauben.";break;case 2:t="Standort nicht verfügbar. GPS aktivieren?";break;case 3:t="Standort-Anfrage Timeout. Bitte erneut versuchen.";break}this._showError(t),a("warn","Geolocation error",{code:e.code,message:e.message})})},_setLoading(r){r?(this._button.classList.add("loading"),this._button.disabled=!0,this._button.title=this.options.strings?.locating||"Wird ermittelt..."):(this._button.classList.remove("loading"),this._button.disabled=!1,this._button.title=this.options.strings?.title||"Mein Standort")},_showSuccess(r){this._userMarker&&this._map.removeLayer(this._userMarker),this._userMarker=d.marker(r,{icon:d.divIcon({className:"md-user-location-marker",html:'<div class="pulse"></div>',iconSize:[20,20]}),title:"Mein Standort"}).addTo(this._map),window.Alpine&&window.Alpine.store&&window.Alpine.store("ui").showNotification(this.options.strings?.found||"Standort gefunden","success",3e3)},_showError(r){window.Alpine&&window.Alpine.store&&window.Alpine.store("ui").showNotification(r,"error",5e3)}}),Qe=d.Control.extend({options:{position:"topright",title:"Ansicht zurücksetzen",bounds:null,center:null,zoom:null},onAdd(r){this._map=r,!this.options.bounds&&!this.options.center&&(this._initialCenter=r.getCenter(),this._initialZoom=r.getZoom());const e=d.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-reset");return this._button=d.DomUtil.create("button","md-icon-button",e),this._button.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
        <path d="M21 3v5h-5"></path>
        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
        <path d="M3 21v-5h5"></path>
      </svg>
    `,this._button.title=this.options.title||"Ansicht zurücksetzen",this._button.setAttribute("aria-label",this.options.title||"Ansicht zurücksetzen"),d.DomEvent.disableClickPropagation(e),d.DomEvent.disableScrollPropagation(e),d.DomEvent.on(this._button,"click",this._handleClick,this),e},onRemove(r){d.DomEvent.off(this._button,"click",this._handleClick,this)},_handleClick(){this.options.bounds?this._map.fitBounds(this.options.bounds,{padding:[50,50],animate:!0}):this.options.center&&this.options.zoom?this._map.setView(this.options.center,this.options.zoom,{animate:!0}):this._map.setView(this._initialCenter,this._initialZoom,{animate:!0}),a("info","Map view reset")}}),Je=d.Control.extend({options:{position:"topright",title:"Kartenstil wechseln",layers:{},defaultLayer:"street"},onAdd(r){this._map=r,this._currentLayer=this.options.defaultLayer||"street";const e=d.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-layers-switcher");return this._button=d.DomUtil.create("button","md-icon-button",e),this._button.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <path d="M12 18v-4"></path>
        <path d="M8 16h8"></path>
      </svg>
    `,this._button.title=this.options.title||"Kartenstil wechseln",this._button.setAttribute("aria-label",this.options.title||"Kartenstil wechseln"),this._button.setAttribute("aria-expanded","false"),this._menu=d.DomUtil.create("div","layer-switcher-menu",e),this._menu.style.display="none",Object.keys(this.options.layers||{}).forEach(n=>{const i=d.DomUtil.create("button","layer-option",this._menu);i.textContent=this._getLayerLabel(n),i.setAttribute("data-layer",n),i.setAttribute("role","menuitem"),n===this._currentLayer&&(i.classList.add("active"),i.setAttribute("aria-current","true")),d.DomEvent.on(i,"click",()=>{this._switchLayer(n)})}),d.DomEvent.disableClickPropagation(e),d.DomEvent.disableScrollPropagation(e),d.DomEvent.on(this._button,"click",n=>{const i=this._menu.style.display!=="none";this._menu.style.display=i?"none":"block",this._button.setAttribute("aria-expanded",i?"false":"true")}),d.DomEvent.on(document,"click",n=>{e.contains(n.target)||(this._menu.style.display="none",this._button.setAttribute("aria-expanded","false"))}),e},onRemove(r){d.DomEvent.off(this._button,"click"),d.DomEvent.off(document,"click")},_switchLayer(r){if(r===this._currentLayer)return;const e=this.options.layers?.[this._currentLayer],t=this.options.layers?.[r];t&&(e&&this._map.hasLayer(e)&&this._map.removeLayer(e),this._map.addLayer(t),this._currentLayer=r,this._updateMenuUI(),this._menu.style.display="none",this._button.setAttribute("aria-expanded","false"),a("info",`Switched to ${r} layer`))},_updateMenuUI(){this._menu.querySelectorAll(".layer-option").forEach(e=>{e.getAttribute("data-layer")===this._currentLayer?(e.classList.add("active"),e.setAttribute("aria-current","true")):(e.classList.remove("active"),e.removeAttribute("aria-current"))})},_getLayerLabel(r){return{street:"🗺️ Straßenkarte",satellite:"🛰️ Satellit",terrain:"⛰️ Gelände",dark:"🌙 Dunkel"}[r]||r}});function Xe(r={}){return new Ye(r)}function et(r={}){return new Qe(r)}function tt(r={}){return new Je(r)}function rt(r=768){return window.innerWidth<r?60:80}function nt(r=768){return window.innerWidth<r?1.5:1}function it(r){const e=new Map;return r.forEach(t=>{if(!t.lat||!t.lng)return;const n=`${t.lat.toFixed(6)},${t.lng.toFixed(6)}`;e.has(n)||e.set(n,[]),e.get(n).push(t)}),e}function ot(r){const e=r[0].ort||"Standort",t=r[0].adresse||"",n=r.length,i=r.map(s=>({id:s.id,training:s.training,wochentag:s.wochentag,von:s.von,bis:s.bis,altersgruppe:s.altersgruppe,trainer:s.trainer,probetraining:s.probetraining,anmerkung:s.anmerkung,link:s.link}));return`
    <div class="md-map-location-popup"
         data-trainings-b64="${btoa(encodeURIComponent(JSON.stringify(i)))}"
         x-data="{
           trainings: [],
           sortBy: 'day',
           get sorted() {
             const dayOrder = {Montag:1,Dienstag:2,Mittwoch:3,Donnerstag:4,Freitag:5,Samstag:6,Sonntag:7};
             const list = [...this.trainings];
             switch(this.sortBy) {
               case 'day': return list.sort((a,b) => (dayOrder[a.wochentag]||99) - (dayOrder[b.wochentag]||99));
               case 'time': return list.sort((a,b) => (a.von||'00:00').localeCompare(b.von||'00:00'));
               case 'age': return list.sort((a,b) => (parseInt(a.vonalter)||0) - (parseInt(b.vonalter)||0));
               case 'name': return list.sort((a,b) => a.training.localeCompare(b.training));
               default: return list;
             }
           }
         }"
         x-init="trainings = JSON.parse(decodeURIComponent(atob($el.dataset.trainingsB64)))"
      <!-- Header -->
      <div class="md-map-location-header">
        <div class="md-map-popup-icon">📍</div>
        <div class="md-map-popup-title flex-1">
          <h3 class="md-typescale-title-medium font-bold">${e}</h3>
          <p class="md-typescale-body-small opacity-90">${n} Training${n>1?"s":""} an diesem Standort</p>
          ${t?`<p class="md-typescale-body-small opacity-80 mt-0.5">🏠 ${t}</p>`:""}
        </div>
      </div>

      <!-- Sorting Controls -->
      <div class="md-map-location-sort">
        <div class="flex items-center gap-3">
          <label for="sort-select" class="md-typescale-label-medium font-semibold" style="color: var(--md-sys-color-on-surface);">
            Sortieren nach:
          </label>
          <select id="sort-select"
                  x-model="sortBy"
                  class="md-sort-dropdown">
            <option value="day">📅 Wochentag</option>
            <option value="time">🕐 Uhrzeit</option>
            <option value="age">👥 Altersgruppe</option>
            <option value="name">🥋 Trainingsname</option>
          </select>
        </div>
      </div>

      <!-- Scrollable trainings list -->
      <div class="md-map-location-list">
        <template x-for="(training, index) in sorted" :key="training.id">
          <div class="md-map-location-item">
            <!-- Training header with icon -->
            <div class="flex items-start gap-3 mb-3">
              <div class="md-map-popup-icon" style="width: 36px; height: 36px; font-size: 18px; background-color: rgba(var(--color-primary-rgb, 0, 115, 230), 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                🥋
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="md-typescale-title-small font-semibold mb-1" x-text="training.training"></h4>
                <span x-show="training.probetraining === 'ja'"
                      class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full"
                      style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); font-weight: 600;">
                  ✅ Probetraining möglich
                </span>
              </div>
            </div>

            <!-- Training details grid with consistent styling -->
            <div class="md-map-popup-info-grid" style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; margin-bottom: 1rem;">
              <div class="md-map-popup-info-icon" style="display: flex; align-items: center; justify-content: center; color: var(--md-sys-color-on-surface-variant); font-size: 16px;">
                📅
              </div>
              <div class="md-map-popup-info-value" style="display: flex; align-items: center;">
                <span class="md-typescale-body-medium font-medium" x-text="training.wochentag"></span>
              </div>

              <div class="md-map-popup-info-icon" style="display: flex; align-items: center; justify-content: center; color: var(--md-sys-color-on-surface-variant); font-size: 16px;">
                🕐
              </div>
              <div class="md-map-popup-info-value" style="display: flex; align-items: center;">
                <span class="md-typescale-body-medium font-medium" x-text="training.von + ' - ' + training.bis + ' Uhr'"></span>
              </div>

              <div class="md-map-popup-info-icon" style="display: flex; align-items: center; justify-content: center; color: var(--md-sys-color-on-surface-variant); font-size: 16px;">
                👥
              </div>
              <div class="md-map-popup-info-value" style="display: flex; align-items: center;">
                <span class="md-typescale-body-medium" x-text="training.altersgruppe || 'Alle Altersgruppen'"></span>
              </div>

              <div class="md-map-popup-info-icon" style="display: flex; align-items: center; justify-content: center; color: var(--md-sys-color-on-surface-variant); font-size: 16px;">
                👤
              </div>
              <div class="md-map-popup-info-value" style="display: flex; align-items: center;">
                <span class="md-typescale-body-medium" x-text="training.trainer"></span>
              </div>
            </div>

            <!-- Note with better styling -->
            <div x-show="training.anmerkung"
                 class="md-map-popup-note"
                 style="background: linear-gradient(135deg, var(--md-sys-color-primary-container) 0%, var(--md-sys-color-secondary-container) 100%); color: var(--md-sys-color-on-primary-container); padding: 0.75rem; border-radius: 8px; margin-top: 1rem; border-left: 3px solid var(--color-primary-500);">
              <p class="md-typescale-label-small font-semibold mb-1 opacity-80" style="margin: 0 0 0.25rem 0;">💡 Wichtiger Hinweis</p>
              <p class="md-typescale-body-small" style="margin: 0;" x-text="training.anmerkung"></p>
            </div>

            <!-- Action button with correct color -->
            <div x-show="training.link" class="mt-3">
              <a :href="training.link" target="_blank" rel="noopener noreferrer"
                 class="md-location-action-btn"
                 style="color: white !important;">
                <span style="color: white !important;">Jetzt anmelden</span>
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                </svg>
              </a>
            </div>
          </div>
        </template>
      </div>
    </div>
  `}function at(r,e){return`
    <div class="md-map-popup">
      <!-- Header with gradient background -->
      <div class="md-map-popup-header">
        <div class="md-map-popup-icon">🥋</div>
        <div class="md-map-popup-title">
          <h3 class="md-typescale-title-medium font-bold">${r.training}</h3>
        </div>
      </div>

      <!-- Body content -->
      <div class="md-map-popup-body">
        <!-- Info grid with icons -->
        <div class="md-map-popup-info-grid">
          <div class="md-map-popup-info-icon">📅</div>
          <div class="md-map-popup-info-value">
            <span class="md-typescale-body-medium font-medium">${r.wochentag}</span>
          </div>

          <div class="md-map-popup-info-icon">🕐</div>
          <div class="md-map-popup-info-value">
            <span class="md-typescale-body-medium font-medium">${e.formatZeitrange(r.von,r.bis)}</span>
          </div>

          <div class="md-map-popup-info-icon">📍</div>
          <div class="md-map-popup-info-value">
            <span class="md-typescale-body-medium">${r.ort}</span>
          </div>

          ${r.adresse?`
            <div class="md-map-popup-info-icon">🏠</div>
            <div class="md-map-popup-info-value">
              <span class="md-typescale-body-small">${r.adresse}</span>
            </div>
          `:""}

          <div class="md-map-popup-info-icon">👥</div>
          <div class="md-map-popup-info-value">
            <span class="md-typescale-body-medium">${e.formatAlter(r)}</span>
          </div>

          <div class="md-map-popup-info-icon">👤</div>
          <div class="md-map-popup-info-value">
            <span class="md-typescale-body-medium">${r.trainer}</span>
          </div>

          <div class="md-map-popup-info-icon">${r.probetraining==="ja"?"✅":"❌"}</div>
          <div class="md-map-popup-info-value">
            <span class="md-typescale-body-medium ${r.probetraining==="ja"?"font-semibold":""}"
                  style="color: ${r.probetraining==="ja"?"var(--color-primary-600)":"var(--md-sys-color-on-surface)"};">
              ${r.probetraining==="ja"?"Probetraining möglich":"Kein Probetraining"}
            </span>
          </div>
        </div>

        ${r.anmerkung?`
          <div class="md-map-popup-note">
            <p class="md-typescale-label-small font-semibold mb-1 opacity-80">💡 Wichtiger Hinweis</p>
            <p class="md-typescale-body-small">${r.anmerkung}</p>
          </div>
        `:""}

        ${r.distanceText?`
          <div class="md-map-popup-distance">
            <span class="md-typescale-body-medium">📏 ${r.distanceText} entfernt</span>
          </div>
        `:""}

        ${r.link?`
          <div class="md-map-popup-action">
            <a href="${r.link}" target="_blank" rel="noopener noreferrer" class="md-btn-filled no-underline" style="color: white !important;">
              <span style="color: white !important;">Jetzt anmelden</span>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
              </svg>
            </a>
          </div>
        `:""}
      </div>
    </div>
  `}class st{constructor(e,t,n={}){this.state=e,this.context=t,this.geolocationManager=n.geolocationManager||null}initializeMap(){if(this.context.map)return;if(!document.getElementById("map-view-container")){a("error","Map container not found");return}try{const t=this.loadMapState(),n=t?.center||c.map.defaultCenter,i=t?.zoom||c.map.defaultZoom;this.context.map=d.map("map-view-container",{center:n,zoom:i,zoomControl:!0,keyboard:!0,keyboardPanDelta:80,zoomAnimation:!0,zoomAnimationThreshold:4,fadeAnimation:!0,markerZoomAnimation:!0,inertia:!0,inertiaDeceleration:3e3,inertiaMaxSpeed:1500,scrollWheelZoom:!0,smoothWheelZoom:!0,smoothSensitivity:1}),this.context.map.on("moveend",()=>{this.saveMapState()}),this.applyLeafletRaceConditionFix(),this.addKeyboardNavigation(),this.addScreenReaderSupport(),this.createTileLayers(),this.addCustomControls(),this.addMarkersToMap(),a("info","Map initialized")}catch(t){a("error","Map initialization failed",t)}}applyLeafletRaceConditionFix(){d.Marker.prototype._animateZoom=function(e){if(!this._map)return;const t=this._map._latLngToNewLayerPoint(this._latlng,e.zoom,e.center).round();this._setPos(t)},d.Popup.prototype._animateZoom=function(e){if(!this._map)return;const t=this._map._latLngToNewLayerPoint(this._latlng,e.zoom,e.center),n=this._getAnchor();d.DomUtil.setPosition(this._container,t.add(n))},d.Tooltip&&d.Tooltip.prototype._animateZoom&&(d.Tooltip.prototype._animateZoom=function(e){if(!this._map)return;const t=this._map._latLngToNewLayerPoint(this._latlng,e.zoom,e.center),n=this._getAnchor();d.DomUtil.setPosition(this._container,t.add(n))}),a("info","Leaflet race condition fix applied (Marker, Popup, Tooltip _animateZoom overrides)")}addKeyboardNavigation(){if(!this.context.map)return;const e=this.context.map,t=e.getContainer();t.setAttribute("tabindex","0"),t.setAttribute("role","application"),t.setAttribute("aria-label","Interaktive Karte mit Trainingsstandorten. Verwenden Sie die Pfeiltasten zum Verschieben, Plus und Minus zum Zoomen, und die Tab-Taste um zwischen Markern zu navigieren."),e.on("keydown",n=>{switch(n.originalEvent.key){case"+":case"=":e.zoomIn(),n.originalEvent.preventDefault();break;case"-":case"_":e.zoomOut(),n.originalEvent.preventDefault();break;case"Home":e.setView(c.map.defaultCenter,c.map.defaultZoom,{animate:!0}),n.originalEvent.preventDefault();break;case"End":if(this.context.markers.length>0){const o=d.latLngBounds(this.context.markers.map(s=>s.getLatLng()));e.fitBounds(o,{padding:[50,50]})}n.originalEvent.preventDefault();break}}),a("debug","Keyboard navigation enabled")}addScreenReaderSupport(){if(!this.context.map)return;const e=this.context.map,t=document.createElement("div");t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.setAttribute("class","sr-only"),t.setAttribute("id","map-announcements"),e.getContainer().appendChild(t),this.context.ariaLiveRegion=t,e.on("zoomend",()=>{const n=e.getZoom();this.announceToScreenReader(`Zoom-Stufe ${n}`)}),e.on("layeradd",()=>{if(this.context.markers.length>0){const n=this.context.markers.length;this.announceToScreenReader(`${n} Trainingsstandorte auf der Karte angezeigt`)}}),a("debug","Screen reader support enabled")}announceToScreenReader(e){this.context.ariaLiveRegion&&(this.context.ariaLiveRegion.textContent="",setTimeout(()=>{this.context.ariaLiveRegion&&(this.context.ariaLiveRegion.textContent=e)},100))}createTileLayers(){if(!this.context.map)return;const e={maxZoom:c.map.maxZoom||19,minZoom:c.map.minZoom||10,detectRetina:!0,updateWhenIdle:!0,updateInterval:200,keepBuffer:3,bounds:[[47.9,11.3],[48.3,11.9]],errorTileUrl:"",noWrap:!1},t=d.tileLayer(c.map.tileLayerUrl,{...e,attribution:c.map.attribution,className:"md-map-tiles md-map-tiles-street"}),n=d.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{...e,attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community",className:"md-map-tiles md-map-tiles-satellite"}),i=d.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{...e,maxZoom:17,attribution:"Map data: &copy; OpenStreetMap contributors, SRTM | Map style: &copy; OpenTopoMap (CC-BY-SA)",className:"md-map-tiles md-map-tiles-terrain"});this.context.tileLayers={street:t,satellite:n,terrain:i},t.addTo(this.context.map),this.context.tileLayer=t,Object.values(this.context.tileLayers).forEach(o=>{o.on("tileerror",s=>{a("warn","Tile loading error",{coords:s.coords})})}),a("debug","Tile layers created")}addCustomControls(){if(!this.context.map)return;if(this.context.tileLayers){const t=tt({position:"topright",layers:this.context.tileLayers,defaultLayer:"street"});this.context.map.addControl(t),this.context.layerControl=t}if(c.features?.enableGeolocation){const t=Xe({position:"topright",geolocationManager:this.geolocationManager});this.context.map.addControl(t),this.context.geolocationControl=t}const e=et({position:"topright",center:c.map.defaultCenter,zoom:c.map.defaultZoom});this.context.map.addControl(e),this.context.resetControl=e,a("debug","Custom controls added")}addMarkersToMap(){if(!this.context.map)return;const e=this.context.map;e.stop(),requestAnimationFrame(()=>{if(this.context.map){if(this.context.markerClusterGroup&&(this.context.markerClusterGroup.off(),e.removeLayer(this.context.markerClusterGroup),this.context.markerClusterGroup=null),this.context.markers=[],typeof d.markerClusterGroup!="function"){a("error","Leaflet.markercluster not available - check imports in main.js"),this.addMarkersWithoutClustering();return}this.addMarkersWithClustering()}})}addMarkersWithClustering(){if(!this.context.map)return;const e=this.context.map;this.context.markerClusterGroup&&(this.context.markerClusterGroup.off(),e.removeLayer(this.context.markerClusterGroup),this.context.markerClusterGroup=null),this.context.markers=[];const t=rt(),n=nt(),i=d.markerClusterGroup({chunkedLoading:!0,chunkInterval:200,chunkDelay:50,removeOutsideVisibleBounds:!1,maxClusterRadius:t,spiderfyOnMaxZoom:!0,showCoverageOnHover:!1,zoomToBoundsOnClick:!0,disableClusteringAtZoom:18,animateAddingMarkers:!1,spiderfyDistanceMultiplier:n,animate:!0,singleMarkerMode:!1,iconCreateFunction:u=>{const p=u.getChildCount();let h=50,g=16,f="md-map-cluster-small";return p>=100?(h=70,g=22,f="md-map-cluster-xlarge"):p>=50?(h=65,g=20,f="md-map-cluster-large"):p>=10&&(h=55,g=18,f="md-map-cluster-medium"),d.divIcon({html:`<div class="md-map-cluster ${f}">
                   <span class="md-map-cluster-count" style="font-size: ${g}px">${p}</span>
                 </div>`,className:"md-map-cluster-wrapper",iconSize:d.point(h,h)})}}),o=[],s=[];it(this.context.filteredTrainings).forEach((u,p)=>{const[h,g]=p.split(",").map(Number),f=u.length,k=u[0].ort,M=this.createLocationIcon(f,u),y=d.marker([h,g],{icon:M,title:f>1?`${k} (${f} Trainings)`:`${u[0].training} - ${k}`,alt:`Standort: ${k}`,riseOnHover:!0});y.locationTrainings=u,y.trainingId=u[0].id;const N=f>1?ot(u):this.createMapPopup(u[0]);y.bindPopup(N,{maxWidth:f>1?450:400,className:"md-map-popup-container",autoPan:!1,autoClose:!0,autoPanPadding:[50,50]}),y.on("click",z=>{this.centerOnMarker(z.latlng,f>1)}),o.push(y),s.push([h,g])}),i.addLayers(o),this.context.markers=o,e.addLayer(i),this.context.markerClusterGroup=i,s.length>0&&!this.context.userHasInteractedWithMap&&e.fitBounds(s,{padding:[50,50]}),e.once("movestart",()=>{this.context.userHasInteractedWithMap=!0}),a("info",`Added ${o.length} markers to map with clustering`)}addMarkersWithoutClustering(){if(!this.context.map)return;const e=this.context.map,t=[];this.context.filteredTrainings.forEach(n=>{if(!n.lat||!n.lng)return;const i=d.marker([n.lat,n.lng],{title:`${n.training} - ${n.ort}`,alt:`Standort: ${n.ort}`,riseOnHover:!0});i.bindPopup(this.createMapPopup(n),{maxWidth:400,className:"md-map-popup-container",autoPan:!1,autoClose:!0}),i.addTo(e),this.context.markers.push(i),t.push([n.lat,n.lng])}),t.length>0&&!this.context.userHasInteractedWithMap&&e.fitBounds(t,{padding:[50,50]}),e.once("movestart",()=>{this.context.userHasInteractedWithMap=!0}),a("info",`Added ${this.context.markers.length} markers without clustering`)}zoomToFavorites(){if(!this.context.map){a("warn","Map not initialized - cannot zoom to favorites");return}const e=this.context.allTrainings.filter(i=>this.context.favorites.includes(i.id)&&i.lat&&i.lng);if(e.length===0){a("info","No favorites with coordinates found"),this.announceToScreenReader("Keine Favoriten mit Standorten gefunden"),this.context.map.setView(c.map.defaultCenter,c.map.defaultZoom,{animate:!0,duration:1});return}const t=e.map(i=>[i.lat,i.lng]);this.context.map.fitBounds(t,{padding:[80,80],maxZoom:15,animate:!0,duration:1.2}),this.context.userHasInteractedWithMap=!0;const n=e.length;this.announceToScreenReader(`Karte zeigt ${n} Favoriten-Standort${n>1?"e":""}`),a("info",`Zoomed to ${n} favorite locations`)}zoomToTraining(e){const t=this.context.allTrainings.find(n=>n.id===e);if(!t||!t.lat||!t.lng){a("warn",`Training ${e} not found or has no coordinates`);return}this.context.$store.ui.activeView!=="map"&&(this.context.$store.ui.activeView="map"),this.context.$nextTick(()=>{this.context.map||this.initializeMap(),this.context.$nextTick(()=>{const n=this.context.map;if(!n)return;const i=this.context.markers.find(o=>o.trainingId===e);if(i){const o=n.getZoom(),s=17,l=Math.abs(s-o),u=Math.min(1.5,.5+l*.1);n.flyTo([t.lat,t.lng],s,{duration:u,easeLinearity:.2,animate:!0}),this._addZoomHighlight([t.lat,t.lng]),setTimeout(()=>{i.openPopup(),this.announceToScreenReader(`Zu ${t.training} in ${t.ort} gezoomt`)},u*1e3+100),a("info",`Zoomed to training ${e} at ${t.ort}`)}else n.flyTo([t.lat,t.lng],17,{duration:1,easeLinearity:.2,animate:!0}),a("warn",`Marker for training ${e} not found, centered on coordinates`);this.context.userHasInteractedWithMap=!0})})}createLocationIcon(e,t=[]){const i=t[0]?.training?.toLowerCase()||"fam",o={parkour:"#0d47a1",trampolin:"#194d1b",tricking:"#4a148c",movement:"#8d2600",fam:"#880e4f"};let s=o.fam;for(const[h,g]of Object.entries(o))if(i.includes(h)){s=g;break}const l=e>1?Math.min(50,35+e*2):40,u=Math.min(18,12+e*.5),p=e>1;return d.divIcon({html:`
        <div class="md-location-marker">
          <div class="md-location-pin">
            <svg width="36" height="48" viewBox="0 0 36 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <!-- Pin shadow -->
              <ellipse cx="18" cy="46" rx="8" ry="2" fill="rgba(0,0,0,0.2)"/>
              <!-- Pin body with training type color -->
              <path d="M18 0C8.059 0 0 8.059 0 18c0 13.5 18 30 18 30s18-16.5 18-30c0-9.941-8.059-18-18-18z"
                    fill="${s}"/>
              <!-- Pin center circle -->
              <circle cx="18" cy="18" r="10" fill="white"/>
              <!-- Training type initial/icon -->
              <text x="18" y="22" text-anchor="middle" font-size="12" font-weight="bold" fill="${s}">
                ${i.charAt(0).toUpperCase()}
              </text>
            </svg>
          </div>
          ${p?`<div class="md-location-badge" style="font-size: ${u}px; background-color: ${s};">${e}</div>`:""}
        </div>
      `,className:"md-location-marker-wrapper",iconSize:[l,l+12],iconAnchor:[l/2,l+12],popupAnchor:[0,-(l+12)]})}centerOnMarker(e,t=!1){if(!this.context.map)return;const n=this.context.map,i=n.getSize().y,s=n.getSize().x/2,l=i*.7,u=n.latLngToContainerPoint(e),p=u.x-s,h=u.y-l;n.panBy([p,h],{animate:!0,duration:.5,easeLinearity:.25}),a("debug",`Centered on marker at ${e.lat}, ${e.lng}`)}createMapPopup(e){return at(e,v)}_addZoomHighlight(e){if(!this.context.map)return;const t=d.circleMarker(e,{radius:50,fillColor:"var(--color-primary-500)",color:"var(--color-primary-600)",weight:2,opacity:.6,fillOpacity:.2,className:"zoom-highlight"}).addTo(this.context.map);let n=50,i=.6;const o=setInterval(()=>{n+=5,i-=.05,i<=0?(clearInterval(o),this.context.map&&this.context.map.removeLayer(t)):(t.setRadius(n),t.setStyle({opacity:i,fillOpacity:i*.3}))},50)}addUserLocationMarker(e){this.context.map&&(this.context.userLocationMarker&&(this.context.map.removeLayer(this.context.userLocationMarker),this.context.userLocationMarker=null),this.context.geolocationControl&&this.context.geolocationControl._userMarker&&(this.context.map.removeLayer(this.context.geolocationControl._userMarker),this.context.geolocationControl._userMarker=null),this.context.userLocationMarker=d.marker(e,{icon:d.divIcon({className:"md-user-location-marker",html:'<div class="pulse"></div>',iconSize:[24,24],iconAnchor:[12,12]}),title:"Mein Standort",zIndexOffset:1e3}),this.context.userLocationMarker.addTo(this.context.map),a("info","User location marker added to map",e))}cleanupMap(){if(!this.context.map)return;const e=this.context.map;try{e.stop(),e.off(),this.context.tileLayer&&(this.context.tileLayer.off(),e.removeLayer(this.context.tileLayer),this.context.tileLayer=null),this.context.markerClusterGroup&&(this.context.markerClusterGroup.off(),e.removeLayer(this.context.markerClusterGroup),this.context.markerClusterGroup.clearLayers(),this.context.markerClusterGroup=null),this.context.markers.forEach(t=>{t.off(),t.unbindPopup(),e.removeLayer(t),t.trainingId=null}),this.context.markers=[],this.context.ariaLiveRegion&&(this.context.ariaLiveRegion.remove(),this.context.ariaLiveRegion=null),this.context.layerControl&&(e.removeControl(this.context.layerControl),this.context.layerControl=null),this.context.geolocationControl&&(e.removeControl(this.context.geolocationControl),this.context.geolocationControl=null),this.context.resetControl&&(e.removeControl(this.context.resetControl),this.context.resetControl=null),this.context.tileLayers&&(Object.values(this.context.tileLayers).forEach(t=>{t.off(),e.hasLayer(t)&&e.removeLayer(t)}),this.context.tileLayers=null),e.eachLayer(t=>{t.off(),e.removeLayer(t)}),e.remove(),this.context.map=null,this.context.userHasInteractedWithMap=!1,a("info","Map cleaned up successfully")}catch(t){a("error","Map cleanup error",t)}}saveMapState(){if(this.context.map)try{const e=this.context.map.getCenter(),t=this.context.map.getZoom(),n={center:[e.lat,e.lng],zoom:t,timestamp:Date.now()};localStorage.setItem("fam_map_state",JSON.stringify(n)),a("debug","Map state saved",n)}catch(e){a("warn","Failed to save map state",e)}}loadMapState(){try{const e=localStorage.getItem("fam_map_state");if(!e)return null;const t=JSON.parse(e),n=10080*60*1e3;if(Date.now()-t.timestamp>n)return localStorage.removeItem("fam_map_state"),null;const[i,o]=t.center;return i<-90||i>90||o<-180||o>180?null:(a("debug","Map state loaded",t),{center:t.center,zoom:t.zoom})}catch(e){return a("warn","Failed to load map state",e),null}}}class lt{constructor(e,t,n){this.state=e,this.context=t,this.addDistanceToTrainings=n.addDistanceToTrainings,this.applyFilters=n.applyFilters,this.startUpdateCheck=n.startUpdateCheck}async init(){this.context.loading=!0,this.context.error=null;try{const e=this.getCachedData();e&&(this.loadData(e),this.context.fromCache=!0);const t=await fetch(c.jsonUrl+"?_="+Date.now());if(!t.ok){if(e){a("warn","Network error, using cache");return}throw new Error(`HTTP ${t.status}: File not found`)}const n=await t.json();if(!n.version||!n.trainings||!Array.isArray(n.trainings))throw new Error("Invalid data format");const i=v.generateHash(JSON.stringify(n.trainings)),o=e?v.generateHash(JSON.stringify(e.trainings)):null;i!==o&&(a("info","New data available, updating..."),this.loadData(n),this.setCachedData(n),this.context.fromCache=!1),c.features.enableUpdateCheck&&this.startUpdateCheck()}catch(e){a("error","Failed to load trainings",e),this.context.error=e instanceof Error?e.message:String(e)}finally{this.context.loading=!1}}loadData(e){this.context.allTrainings=e.trainings||[],this.context.metadata=e.metadata||null,this.context.fuse=new me(this.context.allTrainings,c.search.fuseOptions),this.state.userPosition&&this.addDistanceToTrainings(),this.applyFilters(),a("info","Data loaded",{trainings:this.context.allTrainings.length,fromCache:this.context.fromCache})}getCachedData(){if(!c.cacheEnabled)return null;try{const e=localStorage.getItem(c.cacheKey);if(!e)return null;const t=JSON.parse(e);return Date.now()-t.timestamp>c.cacheDuration?(localStorage.removeItem(c.cacheKey),null):t.data}catch(e){return a("error","Cache read failed",e),null}}setCachedData(e){if(c.cacheEnabled)try{const t={timestamp:Date.now(),data:e};localStorage.setItem(c.cacheKey,JSON.stringify(t))}catch(t){a("error","Cache write failed",t)}}startUpdateCheckInternal(){this.state.updateCheckInterval||(this.state.updateCheckInterval=setInterval(()=>{this.checkForUpdates()},c.pwa.updateCheckInterval))}async checkForUpdates(){try{const t=await(await fetch(c.versionUrl+"?_="+Date.now())).json();t.version&&t.version!==c.pwa.version&&(this.context.updateAvailable=!0,this.context.latestVersion=t.version,a("info","Update available",{version:t.version}))}catch(e){a("error","Update check failed",e)}}}const b=Object.freeze({GOOGLE:"google",OUTLOOK:"outlook",OFFICE365:"office365",YAHOO:"yahoo",APPLE:"apple",ICAL:"ical"}),ct="https://calendar.google.com/calendar/render",ut="https://outlook.live.com/calendar/0/deeplink/compose",dt="https://outlook.office.com/calendar/0/deeplink/compose",pt="https://calendar.yahoo.com/";function K(r){try{const{start:e,end:t}=$(r),n=new URLSearchParams({action:"TEMPLATE",text:_(r),dates:ht(e,t),details:I(r),location:D(r),trp:"true"}),i=`${ct}?${n.toString()}`;return a("debug","[calendar] Google Calendar URL created",{training:r.id}),i}catch(e){throw a("error","[calendar] Failed to create Google Calendar URL",e),e}}function ht(r,e){const t=n=>n.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}/,"");return`${t(r)}/${t(e)}`}function X(r){try{const{start:e,end:t}=$(r),n=new URLSearchParams({path:"/calendar/action/compose",rru:"addevent",subject:_(r),startdt:e.toISOString(),enddt:t.toISOString(),body:I(r),location:D(r)}),i=`${ut}?${n.toString()}`;return a("debug","[calendar] Outlook Calendar URL created",{training:r.id}),i}catch(e){throw a("error","[calendar] Failed to create Outlook Calendar URL",e),e}}function ee(r){try{const{start:e,end:t}=$(r),n=new URLSearchParams({path:"/calendar/action/compose",rru:"addevent",subject:_(r),startdt:e.toISOString(),enddt:t.toISOString(),body:I(r),location:D(r)}),i=`${dt}?${n.toString()}`;return a("debug","[calendar] Office 365 Calendar URL created",{training:r.id}),i}catch(e){throw a("error","[calendar] Failed to create Office 365 Calendar URL",e),e}}function te(r){try{const{start:e,end:t}=$(r),n=new URLSearchParams({v:"60",title:_(r),st:q(e),et:q(t),desc:I(r),in_loc:D(r)}),i=`${pt}?${n.toString()}`;return a("debug","[calendar] Yahoo Calendar URL created",{training:r.id}),i}catch(e){throw a("error","[calendar] Failed to create Yahoo Calendar URL",e),e}}function q(r){return r.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}/,"")}async function re(r,e={}){const{maxBulk:t=10,delay:n=600,onProgress:i=null}=e;if(!Array.isArray(r)||r.length===0)return{success:!1,message:"Keine Trainings zum Exportieren",exported:0,total:0,errors:null};const o=r.slice(0,t);let s=0;const l=[];try{for(let p=0;p<o.length;p++)try{const h=K(o[p]);if(!window.open(h,"_blank"))throw new Error("Popup blocked");s++,i&&i({current:p+1,total:o.length,training:o[p]}),p<o.length-1&&await new Promise(f=>setTimeout(f,n))}catch(h){const g=h instanceof Error?h.message:String(h);l.push({training:o[p],error:g}),a("error","[calendar] Bulk export error for training",{training:o[p].id,error:h})}const u={success:s>0,message:`${s} von ${o.length} Trainings exportiert`,exported:s,total:o.length,errors:l.length>0?l:null};return a("info","[calendar] Bulk export completed",u),u}catch(u){return a("error","[calendar] Bulk export failed",u),{success:!1,message:"Export fehlgeschlagen",exported:s,total:o.length,errors:l.length>0?l:null}}}async function ft(r,e=b.GOOGLE,t={}){if(!{[b.GOOGLE]:K,[b.OUTLOOK]:X,[b.OFFICE365]:ee,[b.YAHOO]:te}[e])throw new Error(`Unsupported calendar provider: ${e}`);return re(r,t)}function $(r){const e=O(r.wochentag);if(!e)throw new Error("Invalid weekday");const[t,n]=r.von.split(":").map(Number),[i,o]=r.bis.split(":").map(Number),s=new Date(e);s.setHours(t,n,0,0);const l=new Date(e);return l.setHours(i,o,0,0),{start:s,end:l}}function _(r){return`${r.training} - ${r.ort}`}function I(r){const e=[];return e.push(`🏃 ${r.training} Training`),e.push(""),r.altersgruppe&&e.push(`👥 Altersgruppe: ${r.altersgruppe}`),r.trainer&&e.push(`👤 Trainer: ${r.trainer}`),r.anmerkung&&(e.push(""),e.push(`ℹ️ ${r.anmerkung}`)),r.link&&(e.push(""),e.push(`📝 Anmeldung: ${r.link}`)),e.push(""),e.push("---"),e.push("🗓️ Erstellt mit FAM Trainingsplan"),e.push("🔗 https://trainingsplan.freeartsofmovement.com"),e.join(`
`)}function D(r){return r.adresse?`${r.ort}, ${r.adresse}`:r.ort||""}function mt(r,e=null){try{const t=W(r);if(!t)throw new Error("Failed to create iCal event");const n=new Blob([t],{type:"text/calendar;charset=utf-8"}),i=window.URL.createObjectURL(n),o=document.createElement("a");return o.href=i,o.download=e||`training-${r.id}.ics`,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(i),a("debug","[calendar] iCal file downloaded",{training:r.id}),{success:!0,message:"Kalenderdatei heruntergeladen"}}catch(t){return a("error","[calendar] Failed to download iCal file",t),{success:!1,message:"Download fehlgeschlagen",error:t}}}function gt(r,e="trainings.ics"){try{if(!Array.isArray(r)||r.length===0)throw new Error("No trainings provided");const t=r.map(l=>W(l)).filter(Boolean);if(t.length===0)throw new Error("No valid events created");const n=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//FAM Trainingsplan//NONSGML v1.0//EN","CALSCALE:GREGORIAN","METHOD:PUBLISH","X-WR-CALNAME:FAM Trainingsplan","X-WR-TIMEZONE:Europe/Berlin",...t.map(l=>(l||"").split(`
`).slice(2,-2).join(`
`)),"END:VCALENDAR"].join(`
`),i=new Blob([n],{type:"text/calendar;charset=utf-8"}),o=window.URL.createObjectURL(i),s=document.createElement("a");return s.href=o,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(o),a("info","[calendar] iCal bundle downloaded",{count:r.length}),{success:!0,message:`${r.length} Trainings heruntergeladen`,count:r.length}}catch(t){return a("error","[calendar] Failed to download iCal bundle",t),{success:!1,message:"Download fehlgeschlagen",error:t}}}function wt(){const r=navigator.userAgent.toLowerCase(),e=navigator.platform.toLowerCase();return/iphone|ipad|ipod|mac/.test(r)||/mac/.test(e)?b.APPLE:/windows/.test(r)||/win/.test(e)?b.OUTLOOK:(/android/.test(r),b.GOOGLE)}function vt(r){return{[b.GOOGLE]:"Google Calendar",[b.OUTLOOK]:"Outlook Calendar",[b.OFFICE365]:"Office 365 Calendar",[b.YAHOO]:"Yahoo Calendar",[b.APPLE]:"Apple Calendar",[b.ICAL]:"iCal"}[r]||r}const C={createGoogleCalendarUrl:K,createOutlookCalendarUrl:X,createOffice365CalendarUrl:ee,createYahooCalendarUrl:te,bulkAddToGoogleCalendar:re,bulkAddToCalendar:ft,downloadICalFile:mt,downloadICalBundle:gt,detectCalendarProvider:wt,getCalendarProviderName:vt,providers:b};class yt{constructor(e,t,n){this.state=e,this.context=t,this.dependencies=n}get hasActiveFilters(){return this.dependencies.hasActiveFilters}get filteredTrainingsCount(){return this.dependencies.filteredTrainingsCount}addToGoogleCalendar(e){try{const t=C.createGoogleCalendarUrl(e);window.open(t,"_blank"),this.context.$store.ui.showNotification(`${e.training} zu Google Calendar hinzugef�gt`,"success",3e3),a("info","[trainingsplaner] Added to Google Calendar",{training:e.id})}catch(t){a("error","[trainingsplaner] Failed to add to Google Calendar",t),this.context.$store.ui.showNotification("Fehler beim �ffnen von Google Calendar","error",3e3)}}addToCalendar(e,t=null){const n=t||C.detectCalendarProvider();try{let i;switch(n){case"google":i=C.createGoogleCalendarUrl(e);break;case"outlook":i=C.createOutlookCalendarUrl(e);break;case"office365":i=C.createOffice365CalendarUrl(e);break;case"yahoo":i=C.createYahooCalendarUrl(e);break;case"apple":case"ical":C.downloadICalFile(e),this.context.$store.ui.showNotification("Kalenderdatei heruntergeladen","success",3e3);return;default:throw new Error(`Unknown provider: ${n}`)}i&&(window.open(i,"_blank"),this.context.$store.ui.showNotification(`Zu ${C.getCalendarProviderName(n)} hinzugef�gt`,"success",3e3)),a("info","[trainingsplaner] Added to calendar",{training:e.id,provider:n})}catch(i){a("error","[trainingsplaner] Failed to add to calendar",i),this.context.$store.ui.showNotification("Fehler beim �ffnen des Kalenders","error",3e3)}}async bulkAddToGoogleCalendar(){if(this.context.filteredTrainings.length===0){this.context.$store.ui.showNotification("Keine Trainings zum Exportieren","warning",3e3);return}try{this.context.$store.ui.showNotification(`Exportiere ${this.context.filteredTrainings.length} Trainings...`,"info",2e3);const e=await C.bulkAddToGoogleCalendar(this.context.filteredTrainings,{maxBulk:10,delay:600,onProgress:({current:t,total:n})=>{a("debug","[trainingsplaner] Bulk export progress",{current:t,total:n})}});e.success?this.context.$store.ui.showNotification(` ${e.exported} von ${e.total} Trainings zu Google Calendar hinzugef�gt`,"success",5e3):this.context.$store.ui.showNotification(e.message,"error",5e3),a("info","[trainingsplaner] Bulk Google Calendar export",e)}catch(e){a("error","[trainingsplaner] Bulk Google Calendar export failed",e),this.context.$store.ui.showNotification("Fehler beim Bulk-Export. Bitte versuche den .ics Export.","error",5e3)}}async exportAllToCalendar(){if(this.context.filteredTrainings.length===0){this.context.$store.ui.showNotification("Keine Trainings zum Exportieren","warning",3e3);return}try{const e=v.createICalBundle(this.context.filteredTrainings),t=`fam-trainings-${Date.now()}.ics`;v.downloadICalFile(e,t),this.context.$store.ui.showNotification(`${this.context.filteredTrainings.length} Trainings exportiert! <�`,"success",3e3),a("info","Bulk calendar export",{count:this.context.filteredTrainings.length})}catch(e){a("error","Bulk export failed",e),this.context.$store.ui.showNotification("Export fehlgeschlagen. Bitte versuchen Sie es erneut.","error",5e3)}}async exportFavoritesToCalendar(){const e=this.context.allTrainings.filter(t=>this.context.favorites.includes(t.id));if(e.length===0){this.context.$store.ui.showNotification("Keine Favoriten zum Exportieren","warning",3e3);return}try{const t=v.createICalBundle(e),n=`fam-favoriten-${Date.now()}.ics`;v.downloadICalFile(t,n),this.context.$store.ui.showNotification(`${e.length} Favoriten exportiert! P`,"success",3e3)}catch(t){a("error","Favorites export failed",t),this.context.$store.ui.showNotification("Export fehlgeschlagen.","error",5e3)}}async shareCurrentView(){const e=this.context.$store.ui.filters,t=v.createShareLink(e),n=this.hasActiveFilters,i=this.filteredTrainingsCount,o={title:"FAM Trainingsplan",text:n?`${i} Trainings gefunden - Schau dir diese an!`:"Entdecke alle FAM Trainings in M�nchen!",url:t};try{if(navigator.share&&navigator.canShare&&navigator.canShare(o))await navigator.share(o),a("info","View shared via native API");else if(await v.copyToClipboard(t))this.context.$store.ui.showNotification("Link in Zwischenablage kopiert! =�","success",3e3);else throw new Error("Clipboard write failed")}catch(s){s instanceof Error&&s.name!=="AbortError"&&(a("error","Share failed",s),this.context.$store.ui.showNotification("Teilen fehlgeschlagen.","error",3e3))}}async shareFavorites(){if(this.context.favorites.length===0){this.context.$store.ui.showNotification("Keine Favoriten zum Teilen","warning",3e3);return}const t=`${window.location.origin+window.location.pathname}?favorites=true`,i={title:"FAM Trainingsplan - Meine Favoriten",text:`Schau dir meine ${this.context.favorites.length} Lieblings-Trainings an!`,url:t};try{if(navigator.share&&navigator.canShare&&navigator.canShare(i))await navigator.share(i),a("info","Favorites shared via native API");else if(await v.copyToClipboard(t))this.context.$store.ui.showNotification("Favoriten-Link in Zwischenablage kopiert!","success",3e3);else throw new Error("Clipboard write failed")}catch(o){o instanceof Error&&o.name!=="AbortError"&&(a("error","Share favorites failed",o),this.context.$store.ui.showNotification("Teilen fehlgeschlagen.","error",3e3))}}}const bt={heute:{label:"Heute",category:"zeit",color:"primary",apply:(r,e)=>{const n=["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"][new Date().getDay()];r._customTimeFilter="",r.wochentag=n,r.activeQuickFilter="heute"}},morgen:{label:"Morgen",category:"zeit",color:"primary",apply:(r,e)=>{const n=["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"][(new Date().getDay()+1)%7];r._customTimeFilter="",r.wochentag=n,r.activeQuickFilter="morgen"}},wochenende:{label:"Wochenende",category:"zeit",color:"primary",customFilter:!0,apply:(r,e)=>{r.wochentag="",r.activeQuickFilter="wochenende",r._customTimeFilter="wochenende"}},wochentags:{label:"Wochentags",category:"zeit",color:"primary",customFilter:!0,apply:(r,e)=>{r.wochentag="",r.activeQuickFilter="wochentags",r._customTimeFilter="wochentags"}},probetraining:{label:"Probetraining",category:"feature",color:"green",customFilter:!0,apply:(r,e)=>{r.activeQuickFilter="probetraining",r._customFeatureFilter="probetraining"}},inMeinerNaehe:{label:"In meiner Nähe",category:"ort",color:"blue",requiresGeolocation:!0,customFilter:!0,apply:(r,e)=>{e.userPosition&&(r.ort="",r.activeQuickFilter="inMeinerNaehe",r._customLocationFilter="inMeinerNaehe")}},favoriten:{label:"Favoriten",category:"persoenlich",color:"yellow",customFilter:!0,apply:(r,e)=>{r.wochentag="",r.ort="",r.training="",r.altersgruppe="",r.searchTerm="",r._customTimeFilter="",r._customFeatureFilter="",r._customLocationFilter="",r.activeQuickFilter="favoriten",r._customPersonalFilter="favoriten"}}};function xt(){const r=Ve(),e={allTrainings:r.allTrainings,filteredTrainings:r.filteredTrainings,favorites:r.favorites,metadata:r.metadata,fuse:r.fuse,loading:r.loading,error:r.error,fromCache:r.fromCache,userPosition:r.userPosition,geolocationError:r.geolocationError,map:r.map,markers:r.markers,markerClusterGroup:r.markerClusterGroup,userHasInteractedWithMap:r.userHasInteractedWithMap,updateCheckInterval:r.updateCheckInterval,updateAvailable:r.updateAvailable,latestVersion:r.latestVersion,searchTimeout:r.searchTimeout,wochentagOrder:r.wochentagOrder};return Object.defineProperties(e,{wochentage:{get(){const t=["Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag","Sonntag"];return[...this.metadata?.wochentage||t].sort((i,o)=>{const s=t.indexOf(i),l=t.indexOf(o);return s===-1&&l===-1?i.localeCompare(o):s===-1?1:l===-1?-1:s-l})},enumerable:!0},orte:{get(){return this.metadata?.orte||v.extractUnique(this.allTrainings,"ort")},enumerable:!0},trainingsarten:{get(){return this.metadata?.trainingsarten||v.extractUnique(this.allTrainings,"training")},enumerable:!0},altersgruppen:{get(){const t=["Minis","Kids","Teens","Adults"];if(this.metadata?.altersgruppen)return[...this.metadata.altersgruppen].sort((o,s)=>{const l=t.indexOf(o),u=t.indexOf(s);return l===-1&&u===-1?o.localeCompare(s):l===-1?1:u===-1?-1:l-u});const n=this.allTrainings.map(o=>o.altersgruppe).filter(o=>o&&String(o).trim()!==""),i=[];return n.forEach(o=>{String(o).split(",").forEach(s=>{const l=s.trim();l&&!i.includes(l)&&i.push(l)})}),i.sort((o,s)=>{const l=t.indexOf(o),u=t.indexOf(s);return l===-1&&u===-1?o.localeCompare(s):l===-1?1:u===-1?-1:l-u})},enumerable:!0},groupedTrainings:{get(){const n=this.$store?.ui?.groupingMode||"wochentag",i={};this.filteredTrainings.forEach(s=>{let l;n==="ort"?l=s.ort||"Ohne Ort":l=s.wochentag||"Ohne Tag",i[l]||(i[l]=[]),i[l].push(s)});let o;return n==="ort"?o=Object.keys(i).sort((s,l)=>s.localeCompare(l)):o=Object.keys(i).sort((s,l)=>(this.wochentagOrder[s]||999)-(this.wochentagOrder[l]||999)),o.map(s=>({key:s,items:this.sortTrainings(i[s])}))},enumerable:!0},favoriteTrainings:{get(){return this.allTrainings.filter(t=>this.favorites.includes(t.id))},enumerable:!0},hasActiveFilters:{get(){const t=this.$store?.ui?.filters;return t?["wochentag","ort","training","altersgruppe","searchTerm"].reduce((n,i)=>{const o=t[i];return Array.isArray(o)?o.length>0?n+1:n:typeof o=="string"&&o.trim()!==""?n+1:n},0)>0:!1},enumerable:!0},filteredTrainingsCount:{get(){return this.filteredTrainings.length},enumerable:!0}}),e.init=async function(){const t=this;this.urlFiltersManager=new We(t),this.filterEngine=new Ke(r,t,{isFavorite:n=>this.favoritesManager.isFavorite(n),updateUrl:()=>this.urlFiltersManager.updateUrlWithFilters()}),this.favoritesManager=new Ze(r,t,{applyFilters:()=>this.filterEngine.applyFilters()}),this.mapManager=new st(r,t),this.geolocationManager=new qe(r,t,{applyFilters:()=>this.filterEngine.applyFilters(),mapManager:this.mapManager}),this.mapManager.geolocationManager=this.geolocationManager,this.dataLoader=new lt(r,t,{addDistanceToTrainings:()=>this.geolocationManager.addDistanceToTrainings(),applyFilters:()=>this.filterEngine.applyFilters(),startUpdateCheck:()=>this.dataLoader.startUpdateCheckInternal()}),this.actionsManager=new yt(r,t,{get hasActiveFilters(){return t.hasActiveFilters},get filteredTrainingsCount(){return t.filteredTrainingsCount}}),c.features.enableFavorites&&this.favoritesManager.loadFavorites(),c.filters.persistInUrl&&this.urlFiltersManager.loadFiltersFromUrl(),this.watchFilters(),window.addEventListener("keydown",n=>this.handleKeyboardShortcuts(n)),window.addEventListener("scroll",()=>{t.$store?.ui&&(t.$store.ui.showScrollTop=window.scrollY>500)},{passive:!0}),await this.dataLoader.init(),t.$store?.filterOptions&&(t.$store.filterOptions.wochentage=t.wochentage,t.$store.filterOptions.orte=t.orte,t.$store.filterOptions.trainingsarten=t.trainingsarten,t.$store.filterOptions.altersgruppen=t.altersgruppen)},e.watchFilters=function(){const t=this;let n=null;t.$watch("$store.ui.filters",()=>{n!==null&&clearTimeout(n),n=setTimeout(()=>{t.filterEngine.applyFilters(),(t.$store?.ui?.activeView==="map"||t.$store?.ui?.activeView==="split")&&t.map&&t.$nextTick(()=>{t.mapManager.addMarkersToMap()})},250)},{deep:!0}),t.$watch("$store.ui.activeView",i=>{(i==="map"||i==="split")&&t.$nextTick(()=>{t.map?(t.map.stop(),setTimeout(()=>{t.map&&t.map.invalidateSize()},100)):t.mapManager.initializeMap()})}),(t.$store?.ui?.activeView==="map"||t.$store?.ui?.activeView==="split")&&t.$nextTick(()=>{t.map||t.mapManager.initializeMap()})},e.applyFilters=function(){return this.filterEngine.applyFilters()},e.matchesAltersgruppe=function(t,n){return this.filterEngine.matchesAltersgruppe(t,n)},e.loadFavorites=function(){return this.favoritesManager.loadFavorites()},e.isFavorite=function(t){return this.favoritesManager.isFavorite(t)},e.toggleFavorite=function(t){return this.favoritesManager.toggleFavorite(t)},e.quickFilterFavorites=function(){return this.favoritesManager.quickFilterFavorites()},e.quickFilterHeute=function(){const t=this;if(!t.$store?.ui?.filters)return;if(t.$store.ui.filters.activeQuickFilter==="heute")t.$store.ui.filters={wochentag:"",ort:"",training:"",altersgruppe:"",searchTerm:"",activeQuickFilter:null};else{const o=["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"][new Date().getDay()];t.$store.ui.filters.wochentag=o,t.$store.ui.filters.activeQuickFilter="heute"}this.applyFilters()},e.applyQuickFilter=async function(t){const n=this;if(!n.$store?.ui?.filters)return;const i=n.$store.ui.filters.activeQuickFilter,o=bt[t];if(!o){console.warn(`Unknown quick filter: ${t}`);return}if(i===t){if(o.category==="zeit")n.$store.ui.filters.wochentag="",n.$store.ui.filters._customTimeFilter="";else if(o.category==="feature")n.$store.ui.filters._customFeatureFilter="";else if(o.category==="ort")n.$store.ui.filters._customLocationFilter="";else if(o.category==="persoenlich"){n.clearAllFilters();return}n.$store.ui.filters.activeQuickFilter=null,n.applyFilters();return}if(o.requiresGeolocation&&!n.userPosition){if(!await n.requestUserLocation()){n.$store.ui.showNotification('Standort-Zugriff benötigt für "In meiner Nähe" Filter',"warning",3e3);return}n.addDistanceToTrainings()}const s={allTrainings:n.allTrainings,favorites:n.favorites,userPosition:n.userPosition,applyFilters:()=>n.applyFilters()},l=o.apply(n.$store.ui.filters,s);Array.isArray(l)?n.filteredTrainings=l:n.applyFilters(),!window.matchMedia("(min-width: 1024px)").matches&&n.$store?.ui&&setTimeout(()=>{n.$store.ui.mobileFilterOpen=!1,setTimeout(()=>{const p=document.getElementById("main-content");p&&p.scrollIntoView({behavior:"smooth",block:"start"})},200)},150)},e.requestUserLocation=function(){return this.geolocationManager.requestUserLocation()},e.addDistanceToTrainings=function(){return this.geolocationManager.addDistanceToTrainings()},e.setManualLocation=function(t,n,i=""){return this.geolocationManager.setManualLocation(t,n,i)},e.resetLocation=function(){return this.geolocationManager.resetLocation()},e.initializeMap=function(){return this.mapManager.initializeMap()},e.addMarkersToMap=function(){return this.mapManager.addMarkersToMap()},e.createMapPopup=function(t){return this.mapManager.createMapPopup(t)},e.cleanupMap=function(){return this.mapManager.cleanupMap()},e.zoomToFavorites=function(){return this.mapManager.zoomToFavorites()},e.zoomToTraining=function(t){return this.mapManager.zoomToTraining(t)},e.loadFiltersFromUrl=function(){return this.urlFiltersManager.loadFiltersFromUrl()},e.updateUrlWithFilters=function(){return this.urlFiltersManager.updateUrlWithFilters()},e.loadData=function(t){return this.dataLoader.loadData(t)},e.getCachedData=function(){return this.dataLoader.getCachedData()},e.setCachedData=function(t){return this.dataLoader.setCachedData(t)},e.startUpdateCheck=function(){return this.dataLoader.startUpdateCheckInternal()},e.checkForUpdates=function(){return this.dataLoader.checkForUpdates()},e.addToGoogleCalendar=function(t){return this.actionsManager.addToGoogleCalendar(t)},e.addToCalendar=function(t,n=null){return this.actionsManager.addToCalendar(t,n)},e.bulkAddToGoogleCalendar=function(){return this.actionsManager.bulkAddToGoogleCalendar()},e.exportAllToCalendar=function(){return this.actionsManager.exportAllToCalendar()},e.exportFavoritesToCalendar=function(){return this.actionsManager.exportFavoritesToCalendar()},e.shareCurrentView=function(){return this.actionsManager.shareCurrentView()},e.shareFavorites=function(){return this.actionsManager.shareFavorites()},e.sortTrainings=function(t){const i=this.$store?.ui?.sortBy||["wochentag","ort","uhrzeit","training"];return t.sort((o,s)=>{for(const l of i){let u=0;if(l==="wochentag"){const p=o.wochentag&&this.wochentagOrder[o.wochentag]||999,h=s.wochentag&&this.wochentagOrder[s.wochentag]||999;u=p-h}else if(l==="ort")u=(o.ort||"").localeCompare(s.ort||"");else if(l==="uhrzeit"){const p=v.zeitZuMinuten(o.von),h=v.zeitZuMinuten(s.von);u=p-h}else l==="training"&&(u=(o.training||"").localeCompare(s.training||""));if(u!==0)return u}return 0})},e.getTrainingColor=function(t){const n=(t||"").toLowerCase();return n.includes("parkour")?"training-badge badge-parkour":n.includes("trampolin")?"training-badge badge-trampolin":n.includes("tricking")?"training-badge badge-tricking":n.includes("movement")?"training-badge badge-movement":n.includes("fam")?"training-badge badge-fam":n.includes("flips")?"bg-red-100 text-red-800 border-red-200":n.includes("calistenics")||n.includes("calisthenics")?"bg-yellow-100 text-yellow-800 border-yellow-200":"bg-slate-100 text-slate-800 border-slate-200"},e.formatAlter=function(t){return v.formatAlter(t)},e.formatZeitrange=function(t,n){return v.formatZeitrange(t,n)},e.clearAllFilters=function(){const t=this;t.$store?.ui?.filters&&(t.$store.ui.filters={wochentag:[],ort:[],training:[],altersgruppe:[],searchTerm:"",activeQuickFilter:null,_customTimeFilter:"",_customFeatureFilter:"",_customLocationFilter:"",_customPersonalFilter:""}),this.applyFilters()},e.truncateText=function(t,n=30){return t.length<=n?t:t.substring(0,n)+"..."},e.removeCategoryFilter=function(t){const i=this.$store?.ui?.filters;i&&(["wochentag","ort","training","altersgruppe"].includes(t)?i[t]=[]:t==="search"?i.searchTerm="":t==="quickFilter"&&(i.activeQuickFilter=null),this.applyFilters())},e.getActiveFilterChips=function(){const n=this.$store?.ui?.filters;if(!n)return[];const i=[];if(Array.isArray(n.wochentag)&&n.wochentag.length>0&&n.wochentag.forEach(o=>{i.push({category:"wochentag",label:"Wochentag",value:o,remove:()=>this.removeFilterChip("wochentag",o),tooltip:`Klicken zum Entfernen: Wochentag - ${o}`,ariaLabel:`Wochentag ${o} entfernen`,prominent:!0,styleClass:"filter-chip-primary",minTouchTarget:44})}),Array.isArray(n.ort)&&n.ort.length>0&&n.ort.forEach(o=>{i.push({category:"ort",label:"Ort",value:o,remove:()=>this.removeFilterChip("ort",o),tooltip:`Klicken zum Entfernen: Ort - ${o}`,ariaLabel:`Ort ${o} entfernen`,prominent:!0,styleClass:"filter-chip-primary",minTouchTarget:44})}),Array.isArray(n.training)&&n.training.length>0&&n.training.forEach(o=>{i.push({category:"training",label:"Training",value:o,remove:()=>this.removeFilterChip("training",o),tooltip:`Klicken zum Entfernen: Training - ${o}`,ariaLabel:`Training ${o} entfernen`,prominent:!0,styleClass:"filter-chip-primary",minTouchTarget:44})}),Array.isArray(n.altersgruppe)&&n.altersgruppe.length>0&&n.altersgruppe.forEach(o=>{i.push({category:"altersgruppe",label:"Altersgruppe",value:o,remove:()=>this.removeFilterChip("altersgruppe",o),tooltip:`Klicken zum Entfernen: Altersgruppe - ${o}`,ariaLabel:`Altersgruppe ${o} entfernen`,prominent:!0,styleClass:"filter-chip-primary",minTouchTarget:44})}),n.searchTerm&&n.searchTerm.trim()!==""&&i.push({category:"search",label:"Suche",value:n.searchTerm,remove:()=>this.removeFilterChip("search",n.searchTerm),tooltip:`Klicken zum Entfernen: Suche - ${n.searchTerm}`,ariaLabel:`Suche ${n.searchTerm} entfernen`,prominent:!0,styleClass:"filter-chip-primary",minTouchTarget:44}),n.activeQuickFilter){const s={heute:"Heute",morgen:"Morgen",wochenende:"Wochenende",probetraining:"Probetraining",favoriten:"Favoriten","in-meiner-naehe":"In meiner Nähe"}[n.activeQuickFilter]||n.activeQuickFilter;i.push({category:"quickFilter",label:"Quick-Filter",value:s,remove:()=>this.removeFilterChip("quickFilter",n.activeQuickFilter),tooltip:`Klicken zum Entfernen: Quick-Filter - ${s}`,ariaLabel:`Quick-Filter ${s} entfernen`,prominent:!0,styleClass:"filter-chip-primary",minTouchTarget:44})}return i},e.getDisplayedFilterChips=function(){return this.getActiveFilterChips().slice(0,3)},e.getOverflowFilterCount=function(){const t=this.getActiveFilterChips();return Math.max(0,t.length-3)},e.getActiveFilterCount=function(){return this.getActiveFilterChips().length},e.removeFilterChip=function(t,n){const o=this.$store?.ui?.filters;o&&(["wochentag","ort","training","altersgruppe"].includes(t)?Array.isArray(o[t])&&(o[t]=o[t].filter(s=>s!==n)):t==="search"?o.searchTerm="":t==="quickFilter"&&(o.activeQuickFilter=null),this.applyFilters())},e.getResultsCount=function(){return this.filteredTrainings?.length||0},e.getResultsCountText=function(){const t=this.getResultsCount();return t===1?"1 Training gefunden":`${t} Trainings gefunden`},e.shouldShowFilterChips=function(){return this.getActiveFilterCount()>0},e.shouldClearButtonBeProminent=function(){return this.getActiveFilterCount()>=3},e.handleKeyboardShortcuts=function(t){const n=this;if((t.ctrlKey||t.metaKey)&&t.key==="f"&&window.matchMedia("(min-width: 1024px)").matches&&n.$store?.ui&&(t.preventDefault(),n.$store.ui.filterSidebarOpen=!n.$store.ui.filterSidebarOpen),t.key==="Escape"&&n.$store?.ui){if(n.$store.ui.activeView==="map"){n.$store.ui.activeView="list",t.preventDefault();return}if(n.$store.ui.mobileFilterOpen){n.$store.ui.mobileFilterOpen=!1,t.preventDefault();return}}},e.destroy=function(){this.updateCheckInterval&&clearInterval(this.updateCheckInterval),this.map&&this.mapManager.cleanupMap(),this.searchTimeout&&clearTimeout(this.searchTimeout)},e}const x=Object.freeze({DEBOUNCE_DELAY:50,MINIMUM_HEIGHT_CHANGE:5,MINIMUM_HEIGHT:400,MAXIMUM_HEIGHT:1e4,EXTRA_PADDING:40,SCROLL_THROTTLE:250,RESIZE_THROTTLE:100});let w={notifyTimeout:null,lastSentHeight:0,parentOrigin:null,resizeObserver:null,mutationObserver:null,isInitialized:!1,targetElement:null,eventListeners:[]};function Tt(){if(w.parentOrigin)return w.parentOrigin;const r=c;try{if(window.parent!==window)if(document.referrer){const e=new URL(document.referrer);w.parentOrigin=e.origin}else w.parentOrigin=r.iframe?.parentOrigin||"*"}catch(e){a("warn","[iframe-resize] Could not detect parent origin, using fallback",e),w.parentOrigin=r.iframe?.parentOrigin||"*"}return w.parentOrigin&&!ne(w.parentOrigin)&&a("warn","[iframe-resize] Parent origin not in allowed list",{origin:w.parentOrigin}),w.parentOrigin||"*"}function ne(r){const e=c;return e.iframe?.allowedOrigins?e.iframe.allowedOrigins.includes(r):!0}function Ct(){return ie()?window.innerHeight:kt()}function ie(){const r=window;if(r.Alpine?.store)try{return r.Alpine.store("ui").mapView===!0}catch{}const e=document.querySelector('[x-show="$store.ui.mapView"]');return e?window.getComputedStyle(e).display!=="none":!1}function kt(){const r=document.documentElement,e=document.body,t=document.querySelectorAll(".training-card, [data-training-card]");if(t.length>0){const o=t[t.length-1].getBoundingClientRect(),s=Math.ceil(o.bottom+window.scrollY);return Math.max(s+x.EXTRA_PADDING,r.scrollHeight,e.scrollHeight,x.MINIMUM_HEIGHT)}const n=document.querySelector("main, #app, [x-data], #trainings-container");if(n){const i=n.getBoundingClientRect();return Math.max(Math.ceil(i.bottom+window.scrollY+x.EXTRA_PADDING),x.MINIMUM_HEIGHT)}return Math.max(r.scrollHeight,e.scrollHeight,r.offsetHeight,e.offsetHeight,r.clientHeight,e.clientHeight,x.MINIMUM_HEIGHT)}function R(r=null){const e=c;window.parent!==window&&e.iframe?.enabled&&(w.notifyTimeout!==null&&clearTimeout(w.notifyTimeout),w.notifyTimeout=setTimeout(()=>{requestAnimationFrame(()=>{oe(r)})},x.DEBOUNCE_DELAY))}function oe(r=null){const e=Ct(),t=r||Tt();if(Math.abs(e-w.lastSentHeight)<x.MINIMUM_HEIGHT_CHANGE)return;const n=Math.max(x.MINIMUM_HEIGHT,Math.min(e,x.MAXIMUM_HEIGHT));try{const i={type:"resize",height:Math.round(n),timestamp:Date.now(),view:ie()?"map":"list",source:"fam-trainingsplan"};window.parent.postMessage(i,t),w.lastSentHeight=n,a("debug",`[iframe-resize] → ${n}px (${i.view})`,{origin:t})}catch(i){a("error","[iframe-resize] postMessage error",i)}}function Mt(r){if(!ne(r.origin)){a("warn","[iframe-resize] Message from unknown origin",{origin:r.origin});return}r.data?.type==="init"&&(a("debug","[iframe-resize] Received init request"),setTimeout(()=>R(),100)),r.data?.type==="requestHeight"&&(a("debug","[iframe-resize] Received height request"),ae())}function Ft(r,e){const t=[],n=(s,l,u,p={})=>{s.addEventListener(l,u,p),t.push({element:s,event:l,handler:u})};n(window,"load",e),n(window,"resize",e,{passive:!0}),n(window,"orientationchange",e,{passive:!0}),document.fonts?.ready&&document.fonts.ready.then(e),window.Alpine&&(n(document,"alpine:init",e),n(document,"alpine:initialized",e),n(document,"alpine:updated",e));const o=j(e,x.SCROLL_THROTTLE);n(window,"scroll",o,{passive:!0}),n(window,"message",Mt),w.eventListeners=t,a("debug","[iframe-resize] Event listeners attached",{count:t.length})}function Lt(r,e){if(!window.ResizeObserver){a("warn","[iframe-resize] ResizeObserver not supported");return}try{w.resizeObserver=new ResizeObserver(e),w.resizeObserver.observe(r),w.resizeObserver.observe(document.body),a("debug","[iframe-resize] ResizeObserver attached")}catch(t){a("error","[iframe-resize] ResizeObserver setup failed",t)}}function St(r,e){if(!window.MutationObserver){a("warn","[iframe-resize] MutationObserver not supported");return}try{w.mutationObserver=new MutationObserver(e),w.mutationObserver.observe(r,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class","x-show","x-if","hidden"]}),a("debug","[iframe-resize] MutationObserver attached")}catch(t){a("error","[iframe-resize] MutationObserver setup failed",t)}}function H(r={}){if(w.isInitialized)return a("warn","[iframe-resize] Already initialized"),!1;const{parentOrigin:e=null,targetSelector:t="#trainings-container"}=r;e&&(w.parentOrigin=e);const n=document.querySelector(t)||document.querySelector("[x-data]")||document.querySelector("#app")||document.body;if(!n)return a("error","[iframe-resize] Target element not found"),!1;w.targetElement=n;const i=j(()=>R(),x.RESIZE_THROTTLE);Lt(n,i),St(n,i),Ft(n,i),setTimeout(i,100),w.isInitialized=!0;const o=window;return o.notifyParentHeight=R,o.forceIframeResize=ae,a("info","[iframe-resize] ✓ Initialized",{target:t,origin:w.parentOrigin}),!0}function ae(){w.lastSentHeight=0,oe(),a("debug","[iframe-resize] Force resize triggered")}function At(){if(window.self===window.top)return;const r=c;!r.iframe?.enabled||!r.iframe?.autoResize||(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{H()}):H())}At();function Et(){const r=document.activeElement;if(!r)return!1;const e=r.tagName;return["INPUT","TEXTAREA","SELECT"].includes(e)||r.hasAttribute("contenteditable")}function Y(){const r=document.querySelector('input[type="search"], input[placeholder*="Suche"]');r&&r instanceof HTMLInputElement?(r.focus(),a("debug","Search input focused via keyboard shortcut")):a("warn","Search input not found")}function Ot(r){const t=["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"][new Date().getDay()];r.filters.wochentag.includes(t)?r.showNotification(`${t} bereits gefiltert`,"info",2e3):(r.filters.wochentag.push(t),r.showNotification(`Filter: ${t}`,"success",2e3),a("info",`Today filter applied: ${t}`))}function $t(r,e){const n={1:"Montag",2:"Dienstag",3:"Mittwoch",4:"Donnerstag",5:"Freitag",6:"Samstag",7:"Sonntag"}[r];if(!n){a("warn",`Invalid weekday number: ${r}`);return}const i=e.filters.wochentag,o=i.indexOf(n);o===-1?(i.push(n),e.showNotification(`Filter: ${n}`,"success",2e3),a("info",`Weekday filter added: ${n}`)):(i.splice(o,1),e.showNotification(`${n} entfernt`,"info",2e3),a("info",`Weekday filter removed: ${n}`))}function _t(r){if(!r)return a("error","Alpine store not provided to keyboard shortcuts"),()=>{};const e=t=>{if((t.metaKey||t.ctrlKey)&&t.key==="k"){t.preventDefault(),Y();return}if(!Et()){if(t.key==="m"||t.key==="M"){t.preventDefault(),r.toggleMapView(),a("info","Map view toggled via keyboard shortcut (M)");return}if(t.key==="/"){t.preventDefault(),Y();return}if(t.key==="h"||t.key==="H"){t.preventDefault(),Ot(r);return}if(t.key>="1"&&t.key<="7"){t.preventDefault();const n=parseInt(t.key,10);$t(n,r);return}}};return document.addEventListener("keydown",e),a("info","Keyboard shortcuts initialized (AUFGABE 12)",{shortcuts:["Cmd/Ctrl + K: Quick Search","M: Toggle Map","/: Focus Search","H: Today Filter","1-7: Weekday Filters"]}),()=>{document.removeEventListener("keydown",e),a("debug","Keyboard shortcuts cleaned up")}}window.L=xe;const G=window;function It(){m.plugin(de),m.plugin(pe),m.plugin(he),m.plugin(fe),a("debug","Alpine plugins registered",{plugins:["collapse","focus","intersect","persist"]})}It();m.store("ui",{filterSidebarOpen:m.$persist(window.innerWidth>=1024).as("filterSidebarOpen"),sidebarCollapsed:m.$persist(!1).as("fam-trainingsplan-sidebar-collapsed"),mobileFilterOpen:!1,locationSettingsOpen:!1,mapView:!1,activeView:m.$persist("list").as("activeView"),darkMode:m.$persist(!1).as("darkMode"),showScrollTop:!1,viewMode:m.$persist("compact").as("viewMode"),groupingMode:m.$persist("wochentag").as("groupingMode"),sortBy:m.$persist(["wochentag","ort","uhrzeit","training"]).as("sortBy"),scrollDirection:"up",lastScrollY:0,manualLocationSet:m.$persist(!1).as("manualLocationSet"),manualLocation:m.$persist(null).as("manualLocation"),manualLocationAddress:m.$persist("").as("manualLocationAddress"),notification:null,notificationTimeout:null,filters:m.$persist({wochentag:[],ort:[],training:[],altersgruppe:[],searchTerm:"",activeQuickFilter:null,_customTimeFilter:"",_customFeatureFilter:"",_customLocationFilter:"",_customPersonalFilter:""}).as("trainingFilters"),setActiveView(r){["list","split","map","favorites"].includes(r)&&(this.activeView=r)},isActiveView(r){return this.activeView===r},toggleMapView(){const r=this.activeView==="map"?"list":"map";this.setActiveView(r),this.mapView=!this.mapView,this.$nextTick&&this.$nextTick(()=>{G.notifyParentHeight?.()})},showListView(){this.mapView=!1,this.$nextTick(()=>{G.notifyParentHeight?.()})},showNotification(r,e="info",t=3e3){clearTimeout(this.notificationTimeout),this.notification={message:r,type:e,show:!0},t>0&&(this.notificationTimeout=setTimeout(()=>{this.hideNotification()},t))},hideNotification(){this.notification&&(this.notification.show=!1,setTimeout(()=>{this.notification=null},300))},resetFilters(){this.filters={wochentag:[],ort:[],training:[],altersgruppe:[],searchTerm:"",activeQuickFilter:null,_customTimeFilter:"",_customFeatureFilter:"",_customLocationFilter:"",_customPersonalFilter:""}},clearAllFilters(){this.resetFilters()},hasActiveFilters(){const r=this.filters;return r.wochentag.length>0||r.ort.length>0||r.training.length>0||r.altersgruppe.length>0||r.probetraining||r.searchTerm!==""},getActiveFilterCount(){const r=this.filters;return r.wochentag.length+r.ort.length+r.training.length+r.altersgruppe.length+(r.probetraining?1:0)+(r.searchTerm?1:0)},toggleSidebar(){this.sidebarCollapsed=!this.sidebarCollapsed},updateScrollDirection(){const r=window.scrollY;this.scrollDirection=r>this.lastScrollY?"down":"up",this.lastScrollY=r}});m.store("filterOptions",{wochentage:[],orte:[],trainingsarten:[],altersgruppen:[]});function Dt(){try{const r=localStorage.getItem("trainingFilters");if(!r){a("debug","No stored filters found, skipping migration");return}const e=JSON.parse(r);if(!(typeof e.wochentag=="string"||typeof e.ort=="string"||typeof e.training=="string"||typeof e.altersgruppe=="string")){a("debug","Filters already in array format, skipping migration");return}const n={wochentag:e.wochentag?[e.wochentag]:[],ort:e.ort?[e.ort]:[],training:e.training?[e.training]:[],altersgruppe:e.altersgruppe?[e.altersgruppe]:[],searchTerm:e.searchTerm||"",activeQuickFilter:e.activeQuickFilter||null,_customTimeFilter:e._customTimeFilter||"",_customFeatureFilter:e._customFeatureFilter||"",_customLocationFilter:e._customLocationFilter||"",_customPersonalFilter:e._customPersonalFilter||""};localStorage.setItem("trainingFilters",JSON.stringify(n)),a("info","Successfully migrated filter format from strings to arrays",{before:{wochentag:typeof e.wochentag,ort:typeof e.ort,training:typeof e.training,altersgruppe:typeof e.altersgruppe},after:{wochentag:Array.isArray(n.wochentag),ort:Array.isArray(n.ort),training:Array.isArray(n.training),altersgruppe:Array.isArray(n.altersgruppe)}})}catch(r){a("error","Failed to migrate filter format",r)}}Dt();m.data("trainingsplaner",xt);m.start();G.Alpine=m;a("info","Alpine.js initialized",{version:m.version});function Nt(){m.store("ui").darkMode?(document.documentElement.setAttribute("data-theme","dark"),a("info","Dark mode activated from stored preference")):(document.documentElement.setAttribute("data-theme","light"),a("info","Light mode activated"))}Nt();function zt(){const r=m.store("ui");if(!r){a("error","Alpine UI store not available for keyboard shortcuts");return}_t(r)}zt();async function Ut(){if(!c.pwa?.enabled){a("info","PWA disabled in config");return}if(!B().supportsServiceWorker){a("warn","Service Worker not supported");return}try{const{registerSW:e}=await ye(async()=>{const{registerSW:n}=await import("./virtual_pwa-register.CFtM-w0k.js");return{registerSW:n}},__vite__mapDeps([0,1,2,3])),t=e({immediate:!0,onNeedRefresh(){a("info","New content available"),c.pwa?.updateStrategy==="auto"?t(!0):Pt(t)},onOfflineReady(){a("info","App ready for offline use"),m.store("ui").showNotification("App bereit für Offline-Nutzung! 🎉","success",3e3)},onRegisteredSW(n,i){a("info","Service Worker registered",{url:n}),i&&c.pwa?.updateCheckInterval>0&&Rt(i)},onRegisterError(n){a("error","Service Worker registration failed",n)}});Ht(),a("info","PWA initialized successfully")}catch(e){a("error","PWA setup failed",e)}}function Pt(r){m.store("ui").showNotification("Neue Version verfügbar! Klicken zum Aktualisieren.","info",0);const e=t=>{t.target&&t.target.closest("[data-notification]")&&(r(!0),document.removeEventListener("click",e))};document.addEventListener("click",e)}function Rt(r){setInterval(()=>{r.update(),a("debug","Checking for updates...")},c.pwa?.updateCheckInterval||6e4)}function Ht(){const r=()=>{navigator.onLine?(m.store("ui").showNotification("Wieder online! 🌐","success",2e3),a("info","Online mode")):(m.store("ui").showNotification("Keine Internetverbindung - Offline-Modus aktiv","warning",5e3),a("warn","Offline mode"))};window.addEventListener("online",r),window.addEventListener("offline",r),navigator.onLine||r()}function Gt(){if(!c.features?.enableTouchGestures||!B().isTouch)return;const r=c.ui?.touch||{};let e=0,t=0,n=0,i=!1;const o=u=>{e=u.touches[0].clientX,t=u.touches[0].clientY,n=Date.now(),window.scrollY===0&&t<100&&(i=!0)},s=u=>{if(!i)return;const h=u.touches[0].clientY-t;if(h>0){const g=document.getElementById("pull-refresh-indicator");g&&(g.style.opacity=Math.min(h/100,1).toString(),g.style.transform=`translateY(${Math.min(h/2,50)}px)`)}},l=u=>{const p=u.changedTouches[0].clientX,h=u.changedTouches[0].clientY,g=Date.now(),f=p-e,k=h-t,M=g-n,y=m.store("ui");if(i&&k>100&&M<1e3){a("info","Pull-to-refresh triggered"),y.showNotification("Aktualisiere Trainings...","info",2e3),setTimeout(()=>{window.location.reload()},500);const T=document.getElementById("pull-refresh-indicator");T&&(T.style.opacity="0",T.style.transform="translateY(0)"),i=!1;return}if(i){const T=document.getElementById("pull-refresh-indicator");T&&(T.style.opacity="0",T.style.transform="translateY(0)"),i=!1}const N=Math.abs(f)>Math.abs(k)&&M<r.swipeMaxTime,z=Math.abs(f)/M;if(!N||z<r.swipeVelocity)return;if(e>80&&e<window.innerWidth-80&&Math.abs(f)>r.swipeThreshold){const T=y.activeView;if(f<-r.swipeThreshold){const L={list:"map",map:"favorites",favorites:"list"}[T]||"list";y.setActiveView(L),a("info",`Swipe left - switching to ${L} view`);return}if(f>r.swipeThreshold){const L={list:"favorites",map:"list",favorites:"map"}[T]||"list";y.setActiveView(L),a("info",`Swipe right - switching to ${L} view`);return}}if(f<-r.swipeThreshold&&e>window.innerWidth-50){(y.filterSidebarOpen||y.mobileFilterOpen)&&(y.filterSidebarOpen=!1,y.mobileFilterOpen=!1,a("debug","Swipe left from edge - closing filter"));return}if(f>r.swipeThreshold&&e<50){window.innerWidth<(c.ui?.mobileBreakpoint||768)?y.mobileFilterOpen=!0:y.filterSidebarOpen=!0,a("debug","Swipe right from edge - opening filter");return}};document.addEventListener("touchstart",o,{passive:!0}),document.addEventListener("touchmove",s,{passive:!0}),document.addEventListener("touchend",l,{passive:!0}),a("info","Touch gestures initialized (AUFGABE 10: View switching + Pull-to-refresh)")}function Bt(){c.iframe?.enabled&&(H({parentOrigin:c.iframe?.parentOrigin||"*",targetSelector:"#trainings-container"}),a("info","Iframe auto-resize initialized"))}function jt(){if(!(!c.logging?.enabled||!("PerformanceObserver"in window)))try{new PerformanceObserver(e=>{e.getEntries().forEach(t=>{if(t.entryType==="navigation"){const n=t;a("debug","Page Load Performance",{dns:Math.round(n.domainLookupEnd-n.domainLookupStart),tcp:Math.round(n.connectEnd-n.connectStart),ttfb:Math.round(n.responseStart-n.requestStart),download:Math.round(n.responseEnd-n.responseStart),domInteractive:Math.round(n.domInteractive),domComplete:Math.round(n.domComplete),loadComplete:Math.round(n.loadEventEnd)})}})}).observe({entryTypes:["navigation"]})}catch(r){a("warn","Performance monitoring failed",r)}}window.addEventListener("error",r=>{a("error","Global Error",{message:r.message,filename:r.filename,lineno:r.lineno,colno:r.colno,error:r.error}),c.errors?.showUserFriendlyMessages&&m.store("ui").showNotification("Ein Fehler ist aufgetreten. Bitte Seite neu laden.","error",5e3)});window.addEventListener("unhandledrejection",r=>{a("error","Unhandled Promise Rejection",r.reason),c.errors?.showUserFriendlyMessages&&m.store("ui").showNotification("Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.","error",5e3)});document.addEventListener("visibilitychange",()=>{document.hidden?a("debug","Page hidden - pausing updates"):a("debug","Page visible - resuming updates")});async function Vt(){try{await Promise.all([Ut(),Promise.resolve(Gt()),Promise.resolve(Bt())]),jt(),a("info","🚀 App initialized",{version:c.pwa?.version||"1.0.0",env:"production",browser:B(),features:Object.entries(c.features||{}).filter(([,r])=>r).map(([r])=>r)})}catch(r){a("error","App initialization failed",r)}}Vt();export{ye as _};
